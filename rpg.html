<!DOCTYPE html>
<html lang="en">
	<head>
		<!-- Google Tag Manager -->
		<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
		new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
		j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
		'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
		})(window,document,'script','dataLayer','GTM-W8RGXCTR');</script>
		<!-- End Google Tag Manager -->

		<link rel="preconnect" href="https://www.googletagmanager.com">
		<link rel="dns-prefetch" href="https://www.googletagmanager.com">

		<link rel="icon" href="/favicon.ico" type="image/x-icon">

		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=10" id="viewport">
		<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com; connect-src 'self' https://www.googletagmanager.com https://www.google-analytics.com; img-src 'self' data: blob: https:; style-src 'self' 'unsafe-inline'; frame-src https://www.googletagmanager.com;">
		<meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
		<meta name="theme-color" content="#0b1220" media="(prefers-color-scheme: dark)">
		<meta name="description" content="RPG Campaign Tracker - Track world events, locations, NPCs and lore">
		<link rel="canonical" href="https://theflat.gen.nz/rpg">

		<title>RPG Campaign Tracker - theflat.gen.nz</title>
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
		<link rel="icon" href="/favicon-96x96.png" type="image/png" sizes="96x96">
		<link rel="icon" href="/favicon.svg" type="image/svg+xml">
        <link rel="manifest" href="/site.webmanifest">
		<style>
			:root {
				color-scheme: light dark;
				--bg: #ffffff;
				--fg: #111827;
				--muted-fg: #374151;
				--link: #1d4ed8;
				--link-visited: #6d28d9;
				--focus: #f59e0b;
				--border: #d1d5db;
				--hover: #f3f4f6;
			}

			@media (prefers-color-scheme: dark) {
				:root {
					--bg: #0b1220;
					--fg: #e5e7eb;
					--muted-fg: #cbd5e1;
					--link: #93c5fd;
					--link-visited: #c4b5fd;
					--focus: #fbbf24;
					--border: #334155;
					--hover: #1e293b;
				}
			}

			*,
			*::before,
			*::after {
				box-sizing: border-box;
			}

			html,
			body {
				background: var(--bg);
				color: var(--fg);
				height: 100vh;
				height: 100dvh;
				margin: 0;
				padding: 0;
				overflow: hidden;
			}

			body {
				font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
				line-height: 1.55;
				display: -webkit-box;
				display: -webkit-flex;
				display: flex;
				-webkit-box-orient: vertical;
				-webkit-box-direction: normal;
				-webkit-flex-direction: column;
				flex-direction: column;
			}

			.skip-link {
				position: absolute;
				top: 12px;
				left: 12px;
				padding: 10px 12px;
				background: var(--bg);
				color: var(--fg);
				border: 2px solid var(--focus);
				border-radius: 8px;
				text-decoration: none;
				-webkit-transform: translateY(-200%);
				transform: translateY(-200%);
				-webkit-transition: -webkit-transform 120ms ease-in-out;
				transition: transform 120ms ease-in-out;
				z-index: 100;
			}

			.skip-link:focus,
			.skip-link:focus-visible {
				-webkit-transform: translateY(0);
				transform: translateY(0);
			}

			a {

			color: var(--link);
			text-decoration-thickness: 0.12em;
			text-underline-offset: 0.16em;
		}

		a:visited {
			color: var(--link-visited);
		}

		a:focus-visible {
			outline: 3px solid var(--focus);
			outline-offset: 3px;
			border-radius: 4px;
		}

			/* Header */
			header {
				background: var(--bg);
				border-bottom: 2px solid var(--border);
			padding: 4px 8px;
			display: flex;
			align-items: center;
			gap: 12px;
		}

		h1 {
			margin: 0;
			font-size: 1.25rem;
			flex: 1;
		}

		#btn-menu {
			display: none;
			background: none;
			border: none;
			color: var(--fg);
			font-size: 1.5rem;
			cursor: pointer;
			padding: 4px 8px;
		}

		.mobile-overlay {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.5);
			z-index: 40;
		}

		.mobile-overlay.active {
			display: block;
		}

		.nav-links {
			display: flex;
			gap: 16px;
		}

		.nav-links a {
			text-decoration: none;
			padding: 8px 12px;
			border-radius: 6px;
			transition: background 0.2s;
		}

		.nav-links a:hover {
			background: var(--hover);
		}

	/* Main Container */
	.container {
				display: flex;
				flex: 1;
				overflow: hidden;
			}

			/* Sidebar */
			.sidebar {
				width: 280px;
				background: var(--bg);
				border-right: 2px solid var(--border);
			padding: 12px;
			overflow-y: auto;
			flex-shrink: 0;
		}

.sidebar-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 16px;
	}

	.sidebar h2 {
		margin: 0;
		font-size: 1rem;
		color: var(--muted-fg);
		text-transform: uppercase;
		letter-spacing: 0.05em;
	}

	.sidebar-close {
		display: none;
		background: none;
		border: none;
		color: var(--fg);
		font-size: 1.5rem;
		cursor: pointer;
		padding: 4px 8px;
		line-height: 1;
	}

	.category-list {
		list-style: none;
		padding: 0;
		margin: 0 0 24px;
	}

	.category-item {
		padding: 10px;
		margin: 4px 0;
		border-radius: 6px;
		cursor: pointer;
		transition: background 0.2s;
		display: flex;
		justify-content: space-between;
		align-items: center;
	}

	.category-item:hover,
	.category-item.active {
		background: var(--hover);
	}

	.category-item.active {
		font-weight: 600;
		border-left: 3px solid var(--link);
		padding-left: 7px;
	}

	.badge {
		background: var(--border);
		color: var(--fg);
		padding: 2px 8px;
		border-radius: 12px;
		font-size: 0.75rem;
		font-weight: 600;
	}

	.btn {
		padding: 10px 16px;
		background: #000000;
		color: #ffffff;
		text-decoration: none;
		border: none;
		border-radius: 8px;
		font-weight: 600;
		font-size: 0.9375rem;
		cursor: pointer;
		transition: all 0.2s ease;
		text-align: center;
		display: block;
		width: 100%;
		margin-top: 8px;
	}

	.btn:first-of-type {
		margin-top: 0;
	}

	.btn:hover {
		background: #1a1a1a;
		-webkit-transform: translateY(-2px);
		transform: translateY(-2px);
	}

			.btn:focus-visible {
				outline: 3px solid var(--focus);
				outline-offset: 2px;
			}

			@media (prefers-color-scheme: dark) {
				.btn {
					background: #ffffff;
					color: #000000;
				}

				.btn:hover {
					background: #e0e0e0;
				}
			}

			/* Map Area */
			.map-container {
				flex: 1;
				display: flex;
				flex-direction: column;
				overflow: hidden;
			}

			.map-toolbar {
				background: var(--bg);
				border-bottom: 2px solid var(--border);
			padding: 4px 8px;
		}

		.btn-toolbar {
				border: 2px solid var(--border);
				border-radius: 6px;
				font-size: 0.875rem;
				cursor: pointer;
				transition: all 0.2s;
			}

			.btn-toolbar:hover {
				background: var(--hover);
				border-color: var(--link);
			}

			.map-view {
				flex: 1;
				position: relative;
				overflow: hidden;
				background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);
			display: flex;
			align-items: center;
			justify-content: center;
		}

	.map-view.loading::after {
		content: '';
		position: absolute;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		width: 40px;
		height: 40px;
		border: 3px solid var(--border);
		border-top-color: var(--link);
		border-radius: 50%;
		animation: spin 0.8s linear infinite;
		z-index: 10;
	}

	@keyframes spin {
		to { transform: translate(-50%, -50%) rotate(360deg); }
	}

	.map-view svg {
		overflow: hidden;
		width: 100%;
		height: 100%;
		display: block;
	}

	.map-svg {
		width: 100%;
		height: 100%;
		cursor: grab;
		opacity: 0;
		transition: opacity 0.3s ease-in;
		touch-action: none;
	}

	.map-svg.ready {
		opacity: 1;
		transform-style: preserve-3d;
		-webkit-transform-style: preserve-3d;
		/* Optimize rendering for complex SVGs */
		image-rendering: optimizeSpeed;
		shape-rendering: optimizeSpeed;
		/* will-change applied dynamically during transforms only */
	}

	/* Optimize map locations for performance */

	.map-location {
		cursor: pointer;
	}

	.map-location:hover {
		-webkit-filter: brightness(1.2);
		filter: brightness(1.2);
	}

	.map-location circle {
		fill: var(--link);
		stroke: var(--bg);
		stroke-width: 15;
	}

	.map-location text {
		fill: #1a1a1a;
		font-size: 120px;
		font-weight: 600;
		pointer-events: none;
		text-anchor: middle;
		text-shadow: 3px 3px 8px rgba(255, 255, 255, 0.9), -3px -3px 8px rgba(255, 255, 255, 0.9);
		paint-order: stroke;
		stroke: rgba(255, 255, 255, 0.8);
		stroke-width: 4;
	}

	.detail-panel {
		width: 400px;
		background: var(--bg);
		border-left: 2px solid var(--border);
		padding: 12px;
		overflow-y: auto;
		flex-shrink: 0;
	}

	.detail-panel.hidden {
		display: none;
	}

	.detail-header {
		display: flex;
		justify-content: space-between;
		align-items: flex-start;
		margin-bottom: 20px;
	}

			.detail-header h2 {
		margin: 0;
		font-size: 1.5rem;
	}

	.btn-close {
		background: none;
		border: none;
		color: var(--muted-fg);
		font-size: 1.5rem;
		cursor: pointer;
		padding: 4px 8px;
		line-height: 1;
	}

	.btn-close:hover {
		color: var(--fg);
	}

	.detail-section {
		margin-bottom: 24px;
	}

	.detail-section h3 {
		margin: 0 0 12px;
		font-size: 1rem;
		color: var(--muted-fg);
		text-transform: uppercase;
		letter-spacing: 0.05em;
	}

	.detail-section p {
		margin: 0;
		line-height: 1.6;
	}
			.npc-list,
	.item-list {
		list-style: none;
		padding: 0;
		margin: 0;
	}

	.npc-item,
	.item-item {
		padding: 12px;
		margin: 8px 0;
		background: var(--hover);
		border-radius: 6px;
		border: 1px solid var(--border);
	}

	.npc-name,
	.item-name {
		font-weight: 600;
		margin-bottom: 4px;
	}

	.npc-role,
	.item-type {
		color: var(--muted-fg);
		font-size: 0.875rem;
	}
			/* Modal */
	.modal {
		display: none;
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		background: rgba(0, 0, 0, 0.5);
		z-index: 1000;
		align-items: center;
		justify-content: center;
	}

	.modal.active {
		display: flex;
	}

	.modal-content {
		background: var(--bg);
		border-radius: 12px;
		padding: 32px;
		max-width: 600px;
		width: 90%;
		max-height: 90vh;
		overflow-y: auto;
		box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
	}

	.modal-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 24px;
	}

	.modal-header h2 {
		margin: 0;
		font-size: 1.5rem;
	}

	.form-group {
		margin-bottom: 20px;
	}

	.form-group label {
		display: block;
		margin-bottom: 8px;
		font-weight: 600;
		color: var(--fg);
	}

	.form-group input,
	.form-group textarea,
	.form-group select {
		width: 100%;
		padding: 10px 12px;
		border: 2px solid var(--border);
		border-radius: 6px;
		background: var(--bg);
		color: var(--fg);
		font-family: inherit;
		font-size: 1rem;
	}

	.form-group input:focus,
	.form-group textarea:focus,
	.form-group select:focus {
		outline: none;
		border-color: var(--link);
	}

	.form-group textarea {
		resize: vertical;
		min-height: 100px;
	}

	.form-actions {
		display: flex;
		gap: 12px;
		justify-content: flex-end;
		margin-top: 24px;
	}

	.btn-secondary {
		background: var(--border);
		color: var(--fg);
	}

	.btn-secondary:hover {
		background: var(--muted-fg);
	}

	.empty-state {
		text-align: center;
		padding: 60px 20px;
		color: var(--muted-fg);
	}

	.empty-state svg {
		width: 80px;
		height: 80px;
		margin-bottom: 16px;
		opacity: 0.5;
	}

	@media (max-width: 1024px) {
		.detail-panel {
			position: fixed;
			top: 0;
			right: 0;
			height: 100vh;
			z-index: 50;
			box-shadow: -4px 0 12px rgba(0, 0, 0, 0.1);
		}
	}

	@media (max-width: 768px) {
		#btn-menu {
			display: block;
		}

		.sidebar-close {
			display: block;
		}

		.sidebar {
			position: fixed;
			left: -280px;
			top: 0;
			height: 100vh;
			height: 100dvh;
			z-index: 50;
			transition: left 0.3s;
			box-shadow: 4px 0 12px rgba(0, 0, 0, 0.1);
			display: flex;
			flex-direction: column;
		}

		.sidebar.active {
			left: 0;
		}

		.category-list {
			display: flex;
			flex-direction: column;
			flex: 1;
			overflow-y: auto;
			-webkit-overflow-scrolling: touch;
		}

		.detail-panel {
			width: 100%;
			position: fixed;
			top: 0;
			right: -100%;
			height: 100vh;
			height: 100dvh;
			z-index: 50;
			box-shadow: -4px 0 12px rgba(0, 0, 0, 0.1);
			transition: right 0.3s;
		}

		.detail-panel:not(.hidden) {
			right: 0;
		}
		
		.map-view {
			-webkit-overflow-scrolling: touch;
			overflow: auto;
		}

		header {
			padding: 2px 4px;
		}

		h1 {
			font-size: 1.1rem;
		}

		.map-toolbar {
			padding: 2px 4px;
		}

		.btn-toolbar {
			padding: 6px 10px;
			font-size: 0.8rem;
		}
	}

	@media (max-width: 768px) and (orientation: landscape) {
		.sidebar {
			height: 100vh !important;
			height: 100dvh !important;
			overflow: hidden;
			display: flex !important;
			flex-direction: column !important;
		}
		
		.sidebar-header {
			flex-shrink: 0;
			margin-bottom: 2px;
			padding: 4px;
		}
		
		.sidebar-header h2 {
			font-size: 0.75rem;
			margin: 0;
		}
		
		.category-list {
			flex: 1 1 auto !important;
			min-height: 0 !important;
			overflow-y: scroll !important;
			-webkit-overflow-scrolling: touch !important;
			margin-bottom: 2px;
		}
		
		.category-item {
			padding: 6px;
			margin: 1px 0;
			font-size: 0.85rem;
		}
		
		.sidebar .btn {
			flex-shrink: 0;
			margin-top: 2px;
			padding: 4px 8px;
			font-size: 0.7rem;
		}
		
		.sidebar hr {
			margin: 2px 0;
		}

		header {
			padding: 2px 4px;
		}

		h1 {
			font-size: 1rem;
		}

		.map-toolbar {
			padding: 1px 2px;
		}

		.btn-toolbar {
			padding: 4px 8px;
			font-size: 0.75rem;
		}
	}

	@media (prefers-reduced-motion: reduce) {
		.btn,
		.category-item,
		.map-location,
		.sidebar {
			transition: none;
		}

		.btn:hover {
			-webkit-transform: none;
			transform: none;
		}
	}
	</style>
	</head>
	<body>
		<!-- Google Tag Manager (noscript) -->
		<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W8RGXCTR"
		height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
		<!-- End Google Tag Manager (noscript) -->

		<a href="#main-content" class="skip-link">Skip to main content</a>

		<header>
			<button id="btn-menu" aria-label="Toggle menu">☰</button>
			<h1>RPG Campaign Tracker</h1>
			<nav class="nav-links">
				<a href="/">Home</a>
			</nav>
		</header>
		<div class="mobile-overlay" id="mobile-overlay"></div>

		<!-- Sidebar -->
		<div class="container">
			<aside class="sidebar" id="sidebar">
				<div class="sidebar-header">
					<h2>Categories</h2>
					<button class="sidebar-close" id="btn-close-sidebar" aria-label="Close menu">&times;</button>
				</div>
				<ul class="category-list">
					<li class="category-item active" data-category="all">
						<span>All</span>
						<span class="badge" id="badge-all">0</span>
					</li>
					<li class="category-item" data-category="locations">
						<span>Locations</span>
						<span class="badge" id="badge-locations">0</span>
					</li>
					<li class="category-item" data-category="npcs">
						<span>NPCs</span>
						<span class="badge" id="badge-npcs">0</span>
					</li>
					<li class="category-item" data-category="items">
						<span>Items</span>
						<span class="badge" id="badge-items">0</span>
					</li>
					<li class="category-item" data-category="events">
						<span>Events</span>
						<span class="badge" id="badge-events">0</span>
					</li>
				</ul>
				<button class="btn" id="btn-add-new">+ Add New</button>
				<hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border);">
				<label class="btn" id="btn-upload-map-label">
					Upload Map
					<input type="file" id="btn-upload-map" accept=".jpg,.jpeg,.png,.gif,.webp,image/*" style="display: none;">
				</label>
				<button class="btn" id="btn-export">Export Data</button>
				<label class="btn" id="btn-import-label">
					Import Data
					<input type="file" id="btn-import" accept=".json" style="display: none;">
				</label>
			</aside>
		<!-- Map Container -->
		<div class="map-container" id="main-content">
				<div class="map-toolbar">
					<button class="btn-toolbar" id="btn-zoom-in">Zoom In</button>
					<button class="btn-toolbar" id="btn-zoom-out">Zoom Out</button>
					<button class="btn-toolbar" id="btn-reset-view">Reset View</button>
				</div>
				<div class="map-view" id="map-view">
					<svg class="map-svg" id="map-svg" viewBox="0 0 1000 600" preserveAspectRatio="xMidYMid slice">
						<!-- Map background -->
						<defs>
							<pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">
								<path d="M 50 0 L 0 0 0 50" fill="none" stroke="rgba(100,100,100,0.1)" stroke-width="1"/>
							</pattern>
						</defs>
						<rect width="1000" height="600" fill="url(#grid)"/>
						
						<!-- Example locations - will be dynamically populated -->
						<g id="locations-layer"></g>
					</svg>
				</div>
			</div>

			<!-- Detail Panel -->
			<aside class="detail-panel hidden" id="detail-panel">
				<div class="detail-header">
					<h2 id="detail-title">Select a location</h2>
					<button class="btn-close" id="btn-close-detail" aria-label="Close details">&times;</button>
				</div>
				<div id="detail-content">
					<div class="empty-state">
						<p>Click on a location on the map to view details</p>
					</div>
				</div>
			</aside>
		</div>

		<!-- Add New Modal -->
		<div class="modal" id="modal-add">
			<div class="modal-content">
				<div class="modal-header">
					<h2>Add New</h2>
					<button class="btn-close" id="btn-close-modal" aria-label="Close modal">&times;</button>
				</div>
				<form id="form-add">
					<div class="form-group">
						<label for="add-type">Type</label>
						<select id="add-type" name="type" required>
							<option value="">Select type...</option>
							<option value="location">Location</option>
							<option value="npc">NPC</option>
							<option value="item">Item</option>
							<option value="event">Event</option>
						</select>
					</div>
					<div id="form-fields"></div>
					<div class="form-actions">
						<button type="button" class="btn btn-secondary" id="btn-cancel">Cancel</button>
						<button type="submit" class="btn">Save</button>
					</div>
				</form>
			</div>
		</div>

		<script>
			// Data Store
			class DataStore {
				constructor() {
					this.dataFile = '/rpg-data.json';
					this.data = {
						locations: [],
						npcs: [],
						items: [],
						events: []
					};
					this.loaded = false;
				}

				async load() {
					try {
						const response = await fetch(this.dataFile);
						if (response.ok) {
							this.data = await response.json();
							this.loaded = true;
							this.updateBadges();
							
							// Load static map if no custom map is set
							if (!this.data.mapSvg) {
								await this.loadStaticMap();
							}
							
							return true;
						}
					} catch (e) {
						console.error('Error loading data from JSON:', e);
					}
					
					// Fallback to empty state
					this.data = {
						locations: [],
						npcs: [],
						items: [],
						events: [],
						mapSvg: null
					};
					this.loaded = true;
					this.updateBadges();
					
					// Load static map
					await this.loadStaticMap();
					
					return false;
				}

				async loadStaticMap() {
					// Try to load PNG first
					try {

					const response = await fetch('/map.png?t=' + Date.now());
					if (response.ok) {
						const pngBlob = await response.blob();
						const pngUrl = URL.createObjectURL(pngBlob);
						this.data.mapSvg = pngUrl;
						this.data.mapType = 'raster';
						this.data.mapWidth = 11548;
						this.data.mapHeight = 7724;
						this.data.isStaticMap = true;

						return true;
					}
				} catch (e) {
					console.error('[ERROR] Failed to load map.png:', e);
					// PNG not found, try SVG
				}

				// Fallback to PNG loading for static map
				return false;
			}

			save() {
				// Note: This doesn't save to the server automatically
				// Users need to export and commit the JSON file
				this.updateBadges();
			}

			exportData() {
					const dataStr = JSON.stringify(this.data, null, 2);
					const dataBlob = new Blob([dataStr], { type: 'application/json' });
					const url = URL.createObjectURL(dataBlob);
					const link = document.createElement('a');
					link.href = url;
					link.download = 'rpg-data.json';
					document.body.appendChild(link);
					link.click();
					document.body.removeChild(link);
					URL.revokeObjectURL(url);
				}

				async importData(file) {
					try {
						const text = await file.text();
						const imported = JSON.parse(text);
						
						// Validate structure
						if (imported.locations && imported.npcs && imported.items && imported.events) {
							this.data = imported;
							this.updateBadges();
							return true;
						} else {
							throw new Error('Invalid data structure');
						}
					} catch (e) {
						console.error('Error importing data:', e);
						alert('Error importing file. Please ensure it\'s a valid rpg-data.json file.');
						return false;
					}
				}

				async uploadMap(file) {
					try {
					// Handle raster images only (JPG, PNG, etc.)
					if (file.type.startsWith('image/')) {
						const reader = new FileReader();
						
						return new Promise((resolve, reject) => {
							reader.onload = (e) => {
								const img = new Image();
								img.onload = () => {
									this.data.mapSvg = e.target.result; // Store as data URL
									this.data.mapType = 'raster';
									this.data.isStaticMap = false;
									this.data.mapWidth = img.width;
									this.data.mapHeight = img.height;
									resolve(true);
								};
								img.onerror = () => {
									reject(new Error('Failed to load image'));
								};
								img.src = e.target.result;
							};
							reader.onerror = () => reject(new Error('Failed to read file'));
							reader.readAsDataURL(file);
						});
					} else {
						throw new Error('Only image files (PNG, JPG, etc.) are supported.');
					}
				} catch (e) {
					console.error('Error uploading map:', e);
					alert('Error uploading map: ' + e.message);
					return false;
				}
			}

			add(type, item) {
				if (!this.data[type]) {
					this.data[type] = [];
				}
				// Generate a proper integer ID
				const maxId = this.data[type].reduce((max, item) => 
					Math.max(max, item.id || 0), 0);
				item.id = maxId + 1;
				item.createdAt = new Date().toISOString();
				this.data[type].push(item);
				this.save();
				return item;
			}

				get(type, id) {
					return this.data[type]?.find(item => item.id === id);
				}

				getAll(type) {
					return this.data[type] || [];
				}

				update(type, id, updates) {
					const index = this.data[type]?.findIndex(item => item.id === id);
					if (index !== -1) {
						this.data[type][index] = { ...this.data[type][index], ...updates };
						this.save();
						return this.data[type][index];
					}
					return null;
				}

				delete(type, id) {
					if (this.data[type]) {
						this.data[type] = this.data[type].filter(item => item.id !== id);
						this.save();
					}
				}

				updateBadges() {
					document.getElementById('badge-locations').textContent = this.data.locations.length;
					document.getElementById('badge-npcs').textContent = this.data.npcs.length;
					document.getElementById('badge-items').textContent = this.data.items.length;
					document.getElementById('badge-events').textContent = this.data.events.length;
					
					const total = this.data.locations.length + this.data.npcs.length + 
						              this.data.items.length + this.data.events.length;
					document.getElementById('badge-all').textContent = total;
				}
			}
// Load data and initialize app
async function initApp() {
	try {

		await store.load();


		mapController.renderMap();

	} catch (e) {
		console.error('[ERROR] initApp failed:', e);
	}
}

			// Initialize data store
			const store = new DataStore();

			// Map Controller
			class MapController {
				constructor() {
					this.svg = document.getElementById('map-svg');
					this.locationsLayer = document.getElementById('locations-layer');
					this.mainGroup = null;
					this.scale = 1;
					this.translateX = 0;
					this.translateY = 0;
					this.isDragging = false;
					this.startX = 0;
					this.startY = 0;
					this.rafId = null;
					this.transformTimeout = null;
					this.willChangeTimeout = null;
					this.isTransforming = false;

					this.initializeEvents();
				}

				initializeEvents() {
					// Zoom controls
					document.getElementById('btn-zoom-in').addEventListener('click', () => this.zoom(1.2));
					document.getElementById('btn-zoom-out').addEventListener('click', () => this.zoom(0.8));
					document.getElementById('btn-reset-view').addEventListener('click', () => this.resetView());

					// Mouse pan controls
					this.svg.addEventListener('mousedown', (e) => this.startDrag(e), { passive: true });
					document.addEventListener('mousemove', (e) => this.drag(e), { passive: false });
					document.addEventListener('mouseup', (e) => this.endDrag(e), { passive: true });

					// Touch support for mobile panning
					this.svg.addEventListener('touchstart', (e) => this.startDrag(e.touches[0]), { passive: true });
					document.addEventListener('touchmove', (e) => this.drag(e.touches[0]), { passive: false });
					document.addEventListener('touchend', (e) => this.endDrag(e), { passive: true });
			}

		zoom(factor) {
				// Apply zoom immediately
				this.scale *= factor;
				this.scale = Math.max(0.5, Math.min(5, this.scale));
				this.updateTransform();
				
				// Throttle rapid subsequent zooms to prevent overwhelming
				if (this.transformTimeout) return;
				
				this.transformTimeout = setTimeout(() => {
					this.transformTimeout = null;
				}, 50); // Reduced to 50ms for better responsiveness
			}

			resetView() {
				this.scale = 1;
				this.translateX = 0;
				this.translateY = 0;
				this.updateTransform();
			}

			startDrag(e) {
				this.isDragging = true;
				this.startX = e.clientX - this.translateX;
				this.startY = e.clientY - this.translateY;
				this.svg.style.cursor = 'grabbing';
				// Prevent text selection during drag
				if (e.preventDefault) e.preventDefault();
			}

			drag(e) {
				if (!this.isDragging) return;
				
				// Prevent default behavior while dragging (scrolling, etc)
				if (e.preventDefault) e.preventDefault();
				
				// Update position values immediately
				this.translateX = e.clientX - this.startX;
				this.translateY = e.clientY - this.startY;
				
				// Throttle transform updates during drag
				this.updateTransform();
			}

			endDrag(e) {
				if (!this.isDragging) return;
				this.isDragging = false;
				this.svg.style.cursor = 'grab';
				if (e.preventDefault) e.preventDefault();
			}

				updateTransform() {
					// Use RAF for smooth 60fps updates
					if (this.rafId) {
						cancelAnimationFrame(this.rafId);
					}
					
					this.rafId = requestAnimationFrame(() => {
						const target = this.mainGroup || this.locationsLayer;
						if (!target) return;
						
						// Apply transform with no transition for instant feedback
						target.style.transform = 
							`translate3d(${this.translateX}px, ${this.translateY}px, 0) scale(${this.scale})`;
						
						// Mark as transforming and set will-change
						if (!this.isTransforming) {
							this.isTransforming = true;
							target.style.willChange = 'transform';
						}
						
						// Remove will-change after transform completes to save memory
						clearTimeout(this.willChangeTimeout);
						this.willChangeTimeout = setTimeout(() => {
							target.style.willChange = 'auto';
							this.isTransforming = false;
						}, 200);
						
						this.rafId = null;
					});
				}



				renderMap() {
	
			// Show loading state
			const mapView = document.getElementById('map-view');
			mapView.classList.add('loading');

			// Clear existing SVG content first
			this.svg.innerHTML = '';
			this.svg.classList.remove('ready');
			
			// Render custom map if available
			if (store.data.mapSvg && store.data.mapType === 'raster') {
				// Handle raster images (JPG, PNG, etc.)
				const width = store.data.mapWidth || 1000;
				const height = store.data.mapHeight || 600;
				
				// Update viewBox and SVG size
				this.svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
				this.svg.setAttribute('width', '100%');
				this.svg.setAttribute('height', '100%');
				this.svg.setAttribute('preserveAspectRatio', 'xMidYMid slice');
				
				// Create main group for all content
				const mainGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
				mainGroup.setAttribute('id', 'main-group');
				
				// Add image as background
				const image = document.createElementNS('http://www.w3.org/2000/svg', 'image');
				image.setAttribute('href', store.data.mapSvg);
				image.setAttribute('x', '0');
				image.setAttribute('y', '0');
				image.setAttribute('width', width);
				image.setAttribute('height', height);
				image.setAttribute('preserveAspectRatio', 'none');
				
				mainGroup.appendChild(image);
				
				// Create and add locations layer on top
				const locationsLayer = document.createElementNS('http://www.w3.org/2000/svg', 'g');
				locationsLayer.setAttribute('id', 'locations-layer');
				mainGroup.appendChild(locationsLayer);
				
				// Add main group to SVG
				this.svg.appendChild(mainGroup);
				this.mainGroup = mainGroup;
				this.locationsLayer = locationsLayer;
				
				// Wait for image to load before showing
				image.addEventListener('load', () => {
					mapView.classList.remove('loading');
					this.svg.classList.add('ready');
					this.render(); // Render locations after image is loaded and visible
				}, { once: true });
				
				// Fallback: remove loading state after timeout (in case image load event doesn't fire)
				const loadTimeout = setTimeout(() => {
					mapView.classList.remove('loading');
					this.svg.classList.add('ready');
					this.render(); // Render locations after timeout
				}, 5000);
				
				// Clear timeout if image loads
				image.addEventListener('load', () => clearTimeout(loadTimeout), { once: true });
			} else {
				// Default map with grid (fallback)
				this.svg.setAttribute('viewBox', '0 0 1000 600');
				
				// Create defs with grid pattern
				const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
				const pattern = document.createElementNS('http://www.w3.org/2000/svg', 'pattern');
				pattern.setAttribute('id', 'grid');
				pattern.setAttribute('width', '50');
				pattern.setAttribute('height', '50');
				pattern.setAttribute('patternUnits', 'userSpaceOnUse');
				
				const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
				path.setAttribute('d', 'M 50 0 L 0 0 0 50');
				path.setAttribute('fill', 'none');
				path.setAttribute('stroke', 'rgba(100,100,100,0.1)');
				path.setAttribute('stroke-width', '1');
				pattern.appendChild(path);
				defs.appendChild(pattern);
				
				const mainGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
				mainGroup.setAttribute('id', 'main-group');
				
				// Add grid background
				const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
				rect.setAttribute('width', '1000');
				rect.setAttribute('height', '600');
				rect.setAttribute('fill', 'url(#grid)');
				mainGroup.appendChild(rect);
				
				// Create and add locations layer on top
				const locationsLayer = document.createElementNS('http://www.w3.org/2000/svg', 'g');
				locationsLayer.setAttribute('id', 'locations-layer');
				mainGroup.appendChild(locationsLayer);
				
				this.svg.appendChild(defs);
				this.svg.appendChild(mainGroup);
				this.mainGroup = mainGroup;
				this.locationsLayer = locationsLayer;

				// Show the grid (no image to wait for)
				mapView.classList.remove('loading');
				this.svg.classList.add('ready');
				this.render(); // Render locations for default grid
			}
		}

		render() {
			const locations = store.getAll('locations');
			const centerX = 5774;
			const centerY = 3862;
			const rangeX = 11548 * 0.4;
			const rangeY = 7724 * 0.4;

			locations.forEach((location) => {
				const x = location.x || (centerX - rangeX/2 + Math.random() * rangeX);
				const y = location.y || (centerY - rangeY/2 + Math.random() * rangeY);
				
				const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
				g.classList.add('map-location');
				
				const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
				circle.setAttribute('cx', x);
				circle.setAttribute('cy', y);
				circle.setAttribute('r', 80); // Increased from 8 to 80 for 11548×7724 map
				
				const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
				text.setAttribute('x', x);
				text.setAttribute('y', y - 120); // Increased offset from -15 to -120
				text.setAttribute('font-size', '120'); // Added explicit font size
				text.textContent = location.name;
				
				g.appendChild(circle);
				g.appendChild(text);
				
				g.addEventListener('click', () => {
					showLocationDetails(location.id);
				});
				
				this.locationsLayer.appendChild(g);
			});
		}
	}

// Detail Panel Controller
function showLocationDetails(locationId) {
	const location = store.get('locations', locationId);
	const panel = document.getElementById('detail-panel');
	const title = document.getElementById('detail-title');
	const content = document.getElementById('detail-content');

	title.textContent = location.name;

	// Get related NPCs and items
	const relatedNPCs = store.getAll('npcs').filter(npc => npc.locationId === locationId);
	const relatedItems = store.getAll('items').filter(item => item.locationId === locationId);
	
	let html = '<div class="detail-section">';
	html += '<h3>Description</h3>';
	html += '<p>' + (location.description || 'No description available.') + '</p>';
	html += '</div>';
	
	if (location.history) {
		html += '<div class="detail-section">';
		html += '<h3>History</h3>';
		html += '<p>' + location.history + '</p>';
		html += '</div>';
	}
	
	if (relatedNPCs.length > 0) {
		html += '<div class="detail-section">';
		html += '<h3>NPCs</h3>';
		html += '<ul class="npc-list">';
		relatedNPCs.forEach(npc => {
			html += '<li class="npc-item" style="cursor: pointer;" onclick="showItemDetails(\'npcs\', ' + npc.id + ')">';
			html += '<div class="npc-name" style="color: var(--link); text-decoration: underline;">' + npc.name + '</div>';
			html += '<div class="npc-role">' + (npc.role || 'Unknown role') + '</div>';
			html += '</li>';
		});
		html += '</ul>';
		html += '</div>';
	}
	
	if (relatedItems.length > 0) {
		html += '<div class="detail-section">';
		html += '<h3>Items</h3>';
		html += '<ul class="item-list">';
		relatedItems.forEach(item => {
			html += '<li class="item-item" style="cursor: pointer;" onclick="showItemDetails(\'items\', ' + item.id + ')">';
			html += '<div class="item-name" style="color: var(--link); text-decoration: underline;">' + item.name + '</div>';
			html += '<div class="item-type">' + (item.type || 'Unknown type') + '</div>';
			html += '</li>';
		});
		html += '</ul>';
		html += '</div>';
	}
	
	content.innerHTML = html;
	panel.classList.remove('hidden');
	
	// Use visualViewport API to properly display panel at normal scale
	function updateDetailPanelZoom() {
		if (window.visualViewport && window.innerWidth <= 768) {
			const scale = window.visualViewport.scale;
			const vvWidth = window.visualViewport.width;
			const vvHeight = window.visualViewport.height;
			const offsetX = window.visualViewport.offsetLeft;
			const offsetY = window.visualViewport.offsetTop;
			
			if (scale > 1) {
				// Calculate inverse scale
				const inverseScale = 1 / scale;
				
				// The panel needs to be scaled down, so we make it larger before scaling
				// We want the final result to be exactly vvWidth x vvHeight
				const panelWidth = vvWidth * scale;
				const panelHeight = vvHeight * scale;
				
				// Set the panel to fill the visual viewport at normal scale
				panel.style.transform = `scale(${inverseScale})`;
				panel.style.transformOrigin = 'top left';
				panel.style.boxSizing = 'border-box';
				
				// Set dimensions exactly
				panel.style.width = `${panelWidth}px`;
				panel.style.height = `${panelHeight}px`;
				panel.style.minWidth = `${panelWidth}px`;
				panel.style.minHeight = `${panelHeight}px`;
				panel.style.maxWidth = `${panelWidth}px`;
				panel.style.maxHeight = `${panelHeight}px`;
				
				// Position at the visual viewport location
				panel.style.left = `${offsetX}px`;
				panel.style.top = `${offsetY}px`;
				panel.style.right = 'auto';
				
				// Ensure no overflow
				panel.style.overflow = 'hidden';
				panel.style.overflowY = 'auto';
			} else {
				// Reset to normal when not zoomed
				panel.style.transform = 'none';
				panel.style.transformOrigin = 'top right';
				panel.style.width = '100%';
				panel.style.height = '100vh';
				panel.style.left = 'auto';
				panel.style.right = '0';
				panel.style.top = '0';
				panel.style.overflow = 'hidden';
				panel.style.overflowY = 'auto';
			}
		}
	}
	
	updateDetailPanelZoom();
	
	// Listen for viewport changes
	if (window.visualViewport) {
		const updateHandler = () => updateDetailPanelZoom();
		window.visualViewport.addEventListener('resize', updateHandler);
		window.visualViewport.addEventListener('scroll', updateHandler);
		
		// Clean up listeners when panel closes
		const originalClose = panel.querySelector('#btn-close-detail');
		if (originalClose) {
			const oldHandler = originalClose.onclick;
			originalClose.onclick = function(e) {
				window.visualViewport.removeEventListener('resize', updateHandler);
				window.visualViewport.removeEventListener('scroll', updateHandler);
				if (oldHandler) oldHandler.call(this, e);
				else hideDetailPanel();
			};
		}
	}
}

function hideDetailPanel() {
	document.getElementById('detail-panel').classList.add('hidden');
	// Allow zoom again when closing detail panel
	const viewportMeta = document.querySelector('meta[name="viewport"]');
	if (viewportMeta) {
		viewportMeta.setAttribute('content', 'width=device-width, initial-scale=1, maximum-scale=10');
	}
}
	function showCategoryList(category) {
		const panel = document.getElementById('detail-panel');
		const title = document.getElementById('detail-title');
		const content = document.getElementById('detail-content');

		let categoryName = category.charAt(0).toUpperCase() + category.slice(1, -1);
		let items = store.getAll(category);

		title.textContent = categoryName;

		if (items.length === 0) {
			content.innerHTML = '<div class="empty-state"><p>No ' + category + ' yet. Click + Add New to create one.</p></div>';
			panel.classList.remove('hidden');
			return;
		}

		const itemsHTML = items.map(item => {
			let html = '<div class="item-list-entry" data-id="' + item.id + '" style="padding: 12px; border: 1px solid var(--border); border-radius: 4px; cursor: pointer; margin-bottom: 8px; transition: all 0.2s;">';
			html += '<div style="font-weight: 600; color: var(--link);">' + item.name + '</div>';
			if (item.role) html += '<div style="font-size: 0.9em; color: var(--muted-fg);">' + item.role + '</div>';
			if (item.type) html += '<div style="font-size: 0.9em; color: var(--muted-fg);">' + item.type + '</div>';
			if (item.date) html += '<div style="font-size: 0.9em; color: var(--muted-fg);">' + item.date + '</div>';
			html += '</div>';
			return html;
		}).join('');

		content.innerHTML = '<div class="item-list-container">' + itemsHTML + '</div>';
		content.querySelectorAll('.item-list-entry').forEach(entry => {
			entry.addEventListener('mouseover', function() {
				this.style.backgroundColor = 'var(--hover)';
				this.style.borderColor = 'var(--link)';
			});
			entry.addEventListener('mouseout', function() {
				this.style.backgroundColor = 'transparent';
				this.style.borderColor = 'var(--border)';
			});
			
			entry.addEventListener('click', () => {
				const itemId = parseInt(entry.dataset.id);
				showItemDetails(category, itemId);
			});
		});

		panel.classList.remove('hidden');
	}

			function showItemDetails(category, itemId) {
				const panel = document.getElementById('detail-panel');
				const title = document.getElementById('detail-title');
				const content = document.getElementById('detail-content');
				const item = store.get(category, itemId);

				if (!item) return;

				title.textContent = item.name;

			let detailsHTML = '<div class="detail-section">';

			if (category === 'locations') {
				if (item.description) detailsHTML += '<div style="margin-bottom: 12px;"><h3>Description</h3><p>' + item.description + '</p></div>';
				if (item.history) detailsHTML += '<div style="margin-bottom: 12px;"><h3>History</h3><p>' + item.history + '</p></div>';

				const relatedNPCs = store.getAll('npcs').filter(npc => npc.locationId === itemId);
				if (relatedNPCs.length > 0) {
					detailsHTML += '<div style="margin-bottom: 12px;"><h3>NPCs Here</h3><ul>';
					relatedNPCs.forEach(npc => {
						detailsHTML += '<li>' + npc.name + (npc.role ? ' - ' + npc.role : '') + '</li>';
					});
					detailsHTML += '</ul></div>';
				}

				const relatedItems = store.getAll('items').filter(itm => itm.locationId === itemId);
				if (relatedItems.length > 0) {
					detailsHTML += '<div style="margin-bottom: 12px;"><h3>Items Here</h3><ul>';
					relatedItems.forEach(itm => {
						detailsHTML += '<li>' + itm.name + (itm.type ? ' (' + itm.type + ')' : '') + '</li>';
					});
					detailsHTML += '</ul></div>';
				}
			} else if (category === 'npcs') {
				if (item.role) detailsHTML += '<div style="margin-bottom: 12px;"><h3>Role/Title</h3><p>' + item.role + '</p></div>';
				if (item.description) detailsHTML += '<div style="margin-bottom: 12px;"><h3>Description</h3><p>' + item.description + '</p></div>';
				if (item.locationId) {
					const location = store.get('locations', item.locationId);
					if (location) detailsHTML += '<div style="margin-bottom: 12px;"><h3>Location</h3><p>' + location.name + '</p></div>';
				}
			} else if (category === 'items') {
				if (item.type) detailsHTML += '<div style="margin-bottom: 12px;"><h3>Type</h3><p>' + item.type + '</p></div>';
				if (item.description) detailsHTML += '<div style="margin-bottom: 12px;"><h3>Description</h3><p>' + item.description + '</p></div>';
				if (item.locationId) {
					const location = store.get('locations', item.locationId);
					if (location) detailsHTML += '<div style="margin-bottom: 12px;"><h3>Found At</h3><p>' + location.name + '</p></div>';
				}
			} else if (category === 'events') {
				if (item.date) detailsHTML += '<div style="margin-bottom: 12px;"><h3>Date/Time</h3><p>' + item.date + '</p></div>';
				if (item.description) detailsHTML += '<div style="margin-bottom: 12px;"><h3>Description</h3><p>' + item.description + '</p></div>';
				if (item.locationId) {
					const location = store.get('locations', item.locationId);
					if (location) detailsHTML += '<div style="margin-bottom: 12px;"><h3>Location</h3><p>' + location.name + '</p></div>';
				}
			}

			if (item.createdAt) {
				detailsHTML += '<div style="font-size: 0.85em; color: var(--muted-fg); margin-top: 16px; padding-top: 8px; border-top: 1px solid var(--border);\">Added ' + new Date(item.createdAt).toLocaleDateString() + '</div>';
			}

			detailsHTML += '</div>';
		content.innerHTML = detailsHTML;
		panel.classList.remove('hidden');
	}

	// Modal Controller
	const modal = document.getElementById('modal-add');
	const form = document.getElementById('form-add');
	const typeSelect = document.getElementById('add-type');
	const formFields = document.getElementById('form-fields');

	function getFormTemplate(type) {
		if (type === 'location') {
			return '<div class="form-group">' +
				'<label for="name">Name</label>' +
				'<input type="text" id="name" name="name" required>' +
				'</div>' +
				'<div class="form-group">' +
				'<label for="description">Description</label>' +
					'<textarea id="description" name="description"></textarea>' +
					'</div>' +
					'<div class="form-group">' +
					'<label for="history">History</label>' +
					'<textarea id="history" name="history"></textarea>' +
					'</div>' +
					'<div class="form-group">' +
					'<label for="x">Map X Position (optional)</label>' +
					'<input type="number" id="x" name="x" min="0" max="1000">' +
					'</div>' +
					'<div class="form-group">' +
					'<label for="y">Map Y Position (optional)</label>' +
					'<input type="number" id="y" name="y" min="0" max="600">' +
					'</div>';
			} else if (type === 'npc') {
				const locations = store.getAll('locations');
				let locationOptions = '<option value="">None</option>';
				locations.forEach(loc => {
					locationOptions += '<option value="' + loc.id + '">' + loc.name + '</option>';
				});
				return '<div class="form-group">' +
					'<label for="name">Name *</label>' +
					'<input type="text" id="name" name="name" required>' +
					'</div>' +
					'<div class="form-group">' +
					'<label for="role">Role/Title</label>' +
					'<input type="text" id="role" name="role">' +
					'</div>' +
					'<div class="form-group">' +
					'<label for="description">Description</label>' +
					'<textarea id="description" name="description"></textarea>' +
					'</div>' +
					'<div class="form-group">' +
					'<label for="locationId">Associated Location</label>' +
					'<select id="locationId" name="locationId">' +
					locationOptions +
					'</select>' +
					'</div>';
			} else if (type === 'item') {
				const locations = store.getAll('locations');
				let locationOptions = '<option value="">Unknown</option>';
				locations.forEach(loc => {
					locationOptions += '<option value="' + loc.id + '">' + loc.name + '</option>';
				});
				return '<div class="form-group">' +
					'<label for="name">Name *</label>' +
					'<input type="text" id="name" name="name" required>' +
					'</div>' +
					'<div class="form-group">' +
					'<label for="type">Type</label>' +
					'<input type="text" id="type" name="type" placeholder="e.g., Weapon, Artifact, Consumable">' +
					'</div>' +
					'<div class="form-group">' +
					'<label for="description">Description</label>' +
					'<textarea id="description" name="description"></textarea>' +
					'</div>' +
					'<div class="form-group">' +
					'<label for="locationId">Found At</label>' +
					'<select id="locationId" name="locationId">' +
					locationOptions +
					'</select>' +
					'</div>';
			} else if (type === 'event') {
				const locations = store.getAll('locations');
				let locationOptions = '<option value="">Unknown</option>';
				locations.forEach(loc => {
					locationOptions += '<option value="' + loc.id + '">' + loc.name + '</option>';
				});
				return '<div class="form-group">' +
					'<label for="name">Event Name *</label>' +
					'<input type="text" id="name" name="name" required>' +
					'</div>' +
					'<div class="form-group">' +
					'<label for="date">Date/Time</label>' +
					'<input type="text" id="date" name="date" placeholder="e.g., Day 15 of Midsummer">' +
					'</div>' +
					'<div class="form-group">' +
					'<label for="description">Description</label>' +
					'<textarea id="description" name="description"></textarea>' +
					'</div>' +
					'<div class="form-group">' +
					'<label for="locationId">Location</label>' +
					'<select id="locationId" name="locationId">' +
					locationOptions +
					'</select>' +
					'</div>';
			}
			return '';
		}

		typeSelect.addEventListener('change', (e) => {
			const type = e.target.value;
			formFields.innerHTML = getFormTemplate(type);
	});

	document.getElementById('btn-add-new').addEventListener('click', () => {
		modal.classList.add('active');
	});

	document.getElementById('btn-close-modal').addEventListener('click', () => {
		modal.classList.remove('active');
		form.reset();
		formFields.innerHTML = '';
	});

	document.getElementById('btn-cancel').addEventListener('click', () => {
		modal.classList.remove('active');
		form.reset();
		formFields.innerHTML = '';
	});

	form.addEventListener('submit', (e) => {
		e.preventDefault();
		
		const formData = new FormData(form);
		const data = Object.fromEntries(formData);
		const type = data.type + 's'; // Convert to plural for storage
		
		delete data.type;
		
		// Convert numeric fields
		if (data.x) data.x = parseFloat(data.x);
		if (data.y) data.y = parseFloat(data.y);
		
		store.add(type, data);
		
		modal.classList.remove('active');
		form.reset();
		formFields.innerHTML = '';
		
		// Refresh map if location was added
		if (type === 'locations') {
			mapController.render();
		}
	});

	// Close detail panel
	document.getElementById('btn-close-detail').addEventListener('click', hideDetailPanel);

	// Category filter
	document.querySelectorAll('.category-item').forEach(item => {
		item.addEventListener('click', () => {
			document.querySelectorAll('.category-item').forEach(i => i.classList.remove('active'));
			item.classList.add('active');
			
			const category = item.dataset.category;
			if (category === 'all') {
				hideDetailPanel();
			} else {
				showCategoryList(category);
			}
		});
	});

	// Initialize
	const mapController = new MapController();
	
	// Export functionality
	document.getElementById('btn-export').addEventListener('click', () => {
		store.exportData();
	});

	// Import functionality
	document.getElementById('btn-import').addEventListener('change', async (e) => {
		const file = e.target.files[0];
		if (file) {
			const success = await store.importData(file);
			if (success) {
				mapController.render();
				alert('Data imported successfully!');
			}
			// Reset input so same file can be imported again
			e.target.value = '';
		}
	});

	// Upload Map functionality
	document.getElementById('btn-upload-map').addEventListener('change', async (e) => {
		const file = e.target.files[0];
		if (file) {
			const success = await store.uploadMap(file);
			if (success) {
				mapController.renderMap();
				alert('Map uploaded successfully! Don\'t forget to export your data to save the map.');
			}
			// Reset input so same file can be uploaded again
			e.target.value = '';
		}
	});

	// Mobile menu toggle
	const sidebar = document.getElementById('sidebar');
	const menuBtn = document.getElementById('btn-menu');
	const overlay = document.getElementById('mobile-overlay');
	const closeSidebarBtn = document.getElementById('btn-close-sidebar');

	function closeSidebar() {
		sidebar.classList.remove('active');
		overlay.classList.remove('active');
	}

	menuBtn.addEventListener('click', () => {
		sidebar.classList.toggle('active');
		overlay.classList.toggle('active');
	});

	overlay.addEventListener('click', closeSidebar);

	// Close button for sidebar
	if (closeSidebarBtn) {
		closeSidebarBtn.addEventListener('click', closeSidebar);
	}

	// Close menu when clicking on a category
	document.querySelectorAll('.category-item').forEach(item => {
		item.addEventListener('click', closeSidebar);
	});
	
	// Start the app
	initApp();
	</script>
</body>
</html>

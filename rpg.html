<!DOCTYPE html>
<html lang="en">
	<head>
		<!-- Google Tag Manager -->
		<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
		new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
		j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
		'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
		})(window,document,'script','dataLayer','GTM-W8RGXCTR');</script>
		<!-- End Google Tag Manager -->

		<link rel="preconnect" href="https://www.googletagmanager.com">
		<link rel="dns-prefetch" href="https://www.googletagmanager.com">

		<link rel="icon" href="/favicon.ico" type="image/x-icon">

		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=10" id="viewport">
		<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com; connect-src 'self' https://www.googletagmanager.com https://www.google-analytics.com https://www.dnd5eapi.co; img-src 'self' data: blob: https:; style-src 'self' 'unsafe-inline'; frame-src https://www.googletagmanager.com;">
		<meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">
		<meta name="theme-color" content="#0b1220" media="(prefers-color-scheme: dark)">
		<meta name="description" content="RPG Campaign Tracker - Track world events, locations, NPCs and lore">
		<link rel="canonical" href="https://theflat.gen.nz/rpg">

		<title>RPG Campaign Tracker - theflat.gen.nz</title>
        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
		<link rel="icon" href="/favicon-96x96.png" type="image/png" sizes="96x96">
		<link rel="icon" href="/favicon.svg" type="image/svg+xml">
        <link rel="manifest" href="/site.webmanifest">
		<style>
			:root {
				color-scheme: light dark;
				--bg: #ffffff;
				--fg: #111827;
				--muted-fg: #374151;
				--link: #1d4ed8;
				--link-visited: #6d28d9;
				--focus: #f59e0b;
				--border: #d1d5db;
				--hover: #f3f4f6;
			}

			@media (prefers-color-scheme: dark) {
				:root {
					--bg: #0b1220;
					--fg: #e5e7eb;
					--muted-fg: #cbd5e1;
					--link: #93c5fd;
					--link-visited: #c4b5fd;
					--focus: #fbbf24;
					--border: #334155;
					--hover: #1e293b;
				}
			}

			*,
			*::before,
			*::after {
				box-sizing: border-box;
			}

			html,
			body {
				background: var(--bg);
				color: var(--fg);
				height: 100vh;
				height: 100dvh;
				margin: 0;
				padding: 0;
				overflow: hidden;
			}

			body {
				font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
				line-height: 1.55;
				display: -webkit-box;
				display: -webkit-flex;
				display: flex;
				-webkit-box-orient: vertical;
				-webkit-box-direction: normal;
				-webkit-flex-direction: column;
				flex-direction: column;
			}

			.skip-link {
				position: absolute;
				top: 12px;
				left: 12px;
				padding: 10px 12px;
				background: var(--bg);
				color: var(--fg);
				border: 2px solid var(--focus);
				border-radius: 8px;
				text-decoration: none;
				-webkit-transform: translateY(-200%);
				transform: translateY(-200%);
				-webkit-transition: -webkit-transform 120ms ease-in-out;
				transition: transform 120ms ease-in-out;
				z-index: 100;
			}

			.skip-link:focus,
			.skip-link:focus-visible {
				-webkit-transform: translateY(0);
				transform: translateY(0);
			}

			a {

			color: var(--link);
			text-decoration-thickness: 0.12em;
			text-underline-offset: 0.16em;
		}

		a:visited {
			color: var(--link-visited);
		}

		a:focus-visible {
			outline: 3px solid var(--focus);
			outline-offset: 3px;
			border-radius: 4px;
		}

			/* Header */
			header {
				background: var(--bg);
				border-bottom: 2px solid var(--border);
			padding: 4px 8px;
			display: flex;
			align-items: center;
			gap: 12px;
		}

		h1 {
			margin: 0;
			font-size: 1.25rem;
			flex: 1;
		}

		#btn-menu {
			display: none;
			background: none;
			border: none;
			color: var(--fg);
			font-size: 1.5rem;
			cursor: pointer;
			padding: 4px 8px;
		}

		#btn-menu:not(.hidden) {
			display: block;
		}

		.btn-menu-close {
			display: none;
			background: none;
			border: none;
			color: var(--fg);
			font-size: 1.5rem;
			cursor: pointer;
			padding: 4px 8px;
			margin-left: auto;
		}

		.btn-menu-close:not(.hidden) {
			display: block;
		}

	/* Hide menu close button on desktop */
	@media (min-width: 769px) {
		.btn-menu-close {
			display: none !important;
		}
	}

	.nav-links {
		display: flex;
		gap: 8px;
	}

	.nav-btn {
		padding: 10px 16px;
		border-radius: 6px;
		cursor: pointer;
		font-size: 0.95rem;
		font-weight: 600;
		transition: all 0.2s;
		border: 1px solid transparent;
		background: var(--bg);
		color: var(--fg);
	}

	.nav-btn[data-page="home"] {
		display: none;
	}

	.nav-btn:hover {
		background: var(--hover);
		border-color: var(--link);
		color: var(--link);
	}

	.nav-btn.active {
		background: var(--link);
		color: var(--bg);
		border-color: var(--link);
	}

	.nav-btn:focus-visible {
		outline: 2px solid var(--focus);
		outline-offset: 2px;
	}

	.nav-links a {
		text-decoration: none;
		padding: 8px 12px;
		border-radius: 6px;
		transition: background 0.2s;
	}

	.nav-links a:hover {
		background: var(--hover);
	}

	/* Main Container */
	.container {
				display: flex;
				flex: 1;
				overflow: hidden;
			}

			/* Sidebar */
			.sidebar {
				width: 280px;
				background: var(--bg);
				border-right: 2px solid var(--border);
				padding: 12px;
				overflow-y: auto;
				-webkit-overflow-scrolling: touch;
				flex-shrink: 0;
				transition: margin-left 0.3s, width 0.3s;
			}

			.sidebar-header {
			display: flex;
			justify-content: space-between;
			align-items: center;
			margin-bottom: 16px;
		}

		.sidebar-close {
			background: none;
			border: none;
			color: var(--fg);
			font-size: 1.5rem;
			cursor: pointer;
			padding: 4px 8px;
			line-height: 1;
		}

	.category-list {
		list-style: none;
		padding: 0;
		margin: 0 0 24px;
	}

	.category-item {
		padding: 10px;
		margin: 4px 0;
		border-radius: 6px;
		cursor: pointer;
		transition: background 0.2s;
		display: flex;
		justify-content: space-between;
		align-items: center;
	}

	.category-item:hover,
	.category-item.active {
		background: var(--hover);
	}

	.category-item.active {
		font-weight: 600;
		border-left: 3px solid var(--link);
		padding-left: 7px;
	}

	.badge {
		background: var(--border);
		color: var(--fg);
		padding: 2px 8px;
		border-radius: 12px;
		font-size: 0.75rem;
		font-weight: 600;
	}

	.search-category-list {
		scrollbar-width: thin;
		scrollbar-color: var(--border) transparent;
	}

	.search-category-list::-webkit-scrollbar {
		width: 8px;
	}

	.search-category-list::-webkit-scrollbar-track {
		background: transparent;
	}

	.search-category-list::-webkit-scrollbar-thumb {
		background: var(--border);
		border-radius: 4px;
	}

	.search-category-list::-webkit-scrollbar-thumb:hover {
		background: var(--muted-fg);
	}

	.btn {
		padding: 10px 16px;
		background: #000000;
		color: #ffffff;
		text-decoration: none;
		border: none;
		border-radius: 8px;
		font-weight: 600;
		font-size: 0.9375rem;
		cursor: pointer;
		transition: all 0.2s ease;
		text-align: center;
		display: block;
		width: 100%;
		margin-top: 8px;
	}

	.btn:first-of-type {
		margin-top: 0;
	}

	.btn:hover {
		background: #1a1a1a;
		-webkit-transform: translateY(-2px);
		transform: translateY(-2px);
	}

			.btn:focus-visible {
				outline: 3px solid var(--focus);
				outline-offset: 2px;
			}

			@media (prefers-color-scheme: dark) {
				.btn {
					background: #ffffff;
					color: #000000;
				}

				.btn:hover {
					background: #e0e0e0;
				}
			}

			/* Map Area */
			.map-container {
				flex: 1;
				display: flex;
				flex-direction: column;
				overflow: hidden;
			}

			.map-toolbar {
				background: var(--bg);
				border-bottom: 2px solid var(--border);
			padding: 4px 8px;
		}

		.btn-toolbar {
				border: 2px solid var(--border);
				border-radius: 6px;
				font-size: 0.875rem;
				cursor: pointer;
				transition: all 0.2s;
			}

			.btn-toolbar:hover {
				background: var(--hover);
				border-color: var(--link);
			}

			.map-view {
				flex: 1;
				position: relative;
			width: 100%;
			overflow: auto;
			background: #dbeafe;
			touch-action: auto;
			-webkit-user-select: none;
			user-select: none;
			/* iOS Safari performance optimizations */
			-webkit-overflow-scrolling: touch;
			overscroll-behavior: contain;
		}

		.map-svg {
			width: 100%;
			height: 100%;
			display: block;
			opacity: 0;
			touch-action: auto;
			-webkit-user-select: none;
			user-select: none;
			max-width: 100%;
			max-height: 100%;
			will-change: transform;
		}

		.map-svg.ready {
			opacity: 1;
			image-rendering: -webkit-optimize-contrast;
			image-rendering: crisp-edges;
		}

		.map-view.loading::after {
			content: '';
			position: absolute;
			top: 50%;
			left: 50%;
			width: 24px;
			height: 24px;
			border: 3px solid var(--border-color);
			border-top-color: var(--link);
			border-radius: 50%;
			animation: spin 1s linear infinite;
			z-index: 100;
			transform: translate(-50%, -50%);
		}

	/* Optimize map locations for performance */

	.map-location {
		cursor: pointer;
	}

	.map-location circle {
		fill: var(--link);
		stroke: var(--bg);
		stroke-width: 2;
	}

	.map-location text {
		fill: #ffffff;
		font-size: 120px;
		font-weight: 600;
		pointer-events: none;
		text-anchor: middle;
		user-select: none;
		-webkit-user-select: none;
		text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8), -1px -1px 2px rgba(0, 0, 0, 0.6);
	}

	.detail-panel {
		position: fixed;
		top: 0;
		right: 0;
		width: 400px;
		height: 100vh;
		background: var(--bg);
		border-left: 2px solid var(--border);
		padding: 12px;
		overflow-y: auto;
		-webkit-overflow-scrolling: touch;
		flex-shrink: 0;
		z-index: 40;
	}

	.detail-panel.hidden {
		display: none;
	}

	.detail-header {
		display: flex;
		justify-content: space-between;
		align-items: flex-start;
		margin-bottom: 20px;
	}

			.detail-header h2 {
		margin: 0;
		font-size: 1.5rem;
	}

	.btn-close {
		background: none;
		border: none;
		color: var(--muted-fg);
		font-size: 1.5rem;
		cursor: pointer;
		padding: 4px 8px;
		line-height: 1;
	}

	.btn-close:hover {
		color: var(--fg);
	}

	.detail-section {
		margin-bottom: 24px;
	}

	.detail-section h3 {
		margin: 0 0 12px;
		font-size: 1rem;
		color: var(--muted-fg);
		text-transform: uppercase;
		letter-spacing: 0.05em;
	}

	.detail-section p {
		margin: 0;
		line-height: 1.6;
	}
			.npc-list,
	.item-list {
		list-style: none;
		padding: 0;
		margin: 0;
	}

	.npc-item,
	.item-item {
		padding: 12px;
		margin: 8px 0;
		background: var(--hover);
		border-radius: 6px;
		border: 1px solid var(--border);
	}

	.npc-name,
	.item-name {
		font-weight: 600;
		margin-bottom: 4px;
	}

	.npc-role,
	.item-type {
		color: var(--muted-fg);
		font-size: 0.875rem;
	}
			/* Modal */
	.modal {
		display: none;
		position: fixed;
		top: 0;
		left: 0;
		width: 100%;
		height: 100%;
		height: 100vh;
		height: 100dvh;
		background: rgba(0, 0, 0, 0.5);
		z-index: 100;
		align-items: center;
		justify-content: center;
		padding: 16px;
	}

	.modal.active {
		display: flex !important;
	}

	.modal-content {
		background: var(--bg);
		border-radius: 12px;
		padding: 32px;
		max-width: 600px;
		width: 90%;
		max-height: 90vh;
		max-height: 90dvh;
		overflow-y: auto;
		-webkit-overflow-scrolling: touch;
		box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
		display: flex;
		flex-direction: column;
	}

	#add-item-modal .modal-content {
		max-width: 700px;
		max-height: 85vh;
	}

	.modal-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 24px;
	}

	.modal-header h2 {
		margin: 0;
		font-size: 1.5rem;
	}

	.form-group {
		margin-bottom: 20px;
	}

	.form-group label {
		display: block;
		margin-bottom: 8px;
		font-weight: 600;
		color: var(--fg);
	}

	/* Equipment Search Styles */
	.equipment-panel {
		display: none;
		flex-direction: column;
		height: 100%;
	}

	.equipment-panel.active {
		display: flex;
	}

	.equipment-search-box {
		padding: 12px;
		border-bottom: 1px solid var(--border);
		flex-shrink: 0;
	}

	.equipment-search-box input {
		width: 100%;
		padding: 10px 12px;
		border: 1px solid var(--border);
		border-radius: 6px;
		background: var(--bg);
		color: var(--fg);
		font-size: 1rem;
	}

	.equipment-search-box input::placeholder {
		color: var(--muted-fg);
	}

	.equipment-results {
		flex: 1;
		overflow-y: auto;
		-webkit-overflow-scrolling: touch;
	}

	.equipment-item {
		padding: 12px;
		margin: 8px 12px;
		background: var(--hover);
		border: 1px solid var(--border);
		border-radius: 6px;
		cursor: pointer;
		transition: all 0.2s;
	}

	.equipment-item:hover {
		background: var(--border);
		transform: translateX(4px);
	}

	.equipment-item-name {
		font-weight: 600;
		color: var(--link);
		margin-bottom: 4px;
	}

	.equipment-item-type {
		font-size: 0.875rem;
		color: var(--muted-fg);
	}

	.equipment-loading {
		padding: 20px;
		text-align: center;
		color: var(--muted-fg);
	}

	.form-group input,
	.form-group textarea,
	.form-group select {
		width: 100%;
		padding: 10px 12px;
		border: 2px solid var(--border);
		border-radius: 6px;
		background: var(--bg);
		color: var(--fg);
		font-family: inherit;
		font-size: 1rem;
	}

	.form-group input:focus,
	.form-group textarea:focus,
	.form-group select:focus {
		outline: none;
		border-color: var(--link);
	}

	.form-group textarea {
		resize: vertical;
		min-height: 100px;
	}

	.form-actions {
		display: flex;
		gap: 12px;
		justify-content: flex-end;
		margin-top: 24px;
	}

	.btn-secondary {
		background: var(--border);
		color: var(--fg);
	}

	.btn-secondary:hover {
		background: var(--muted-fg);
	}

	.hidden {
		display: none !important;
	}

	.empty-state {
		text-align: center;
		padding: 20px;
		color: var(--muted-fg);
	}

	.empty-state svg {
		width: 80px;
		height: 80px;
		margin-bottom: 16px;
		opacity: 0.5;
	}

	@media (max-width: 1024px) {
		.detail-panel {
			position: fixed;
			top: 0;
			right: 0;
			height: 100vh;
			z-index: 50;
			box-shadow: -4px 0 12px rgba(0, 0, 0, 0.1);
		}
	}

	@media (max-width: 768px) {
		#btn-menu {
			display: block;
		}

		.sidebar-close {
			display: block;
		}

		.sidebar {
			position: fixed;
			left: -280px;
			top: 0;
			height: 100vh;
			height: 100dvh;
			z-index: 50;
			transition: left 0.3s;
			box-shadow: 4px 0 12px rgba(0, 0, 0, 0.1);
			display: flex;
			flex-direction: column;
		}

		.sidebar.active {
			left: 0;
		}

		.category-list {
			display: flex;
			flex-direction: column;
			flex: 1;
			overflow-y: auto;
			-webkit-overflow-scrolling: touch;
		}

		.search-category-list {
			max-height: 120px !important;
			flex: 0;
		}

		.detail-panel {
			width: 100%;
			position: fixed;
			top: 0;
			right: -100%;
			height: 100vh;
			height: 100dvh;
			z-index: 50;
			box-shadow: -4px 0 12px rgba(0, 0, 0, 0.1);
			transition: right 0.3s;
		}

		.detail-panel:not(.hidden) {
			right: 0;
		}
		
		.map-view {
			-webkit-overflow-scrolling: touch;
			overflow: auto;
		}

		header {
			padding: 4px 6px;
			gap: 6px;
		}

		h1 {
			display: none;
		}

		.nav-links {
			gap: 6px;
			flex: 1;
		}

		.nav-btn {
			padding: 8px 12px;
			font-size: 0.75rem;
			font-weight: 600;
			border: 1px solid transparent;
			background: var(--bg);
		}

		/* Prevent iOS Safari auto-zoom on focus - only for form inputs */
		input,
		select,
		textarea {
			font-size: 16px !important;
		}

		.map-toolbar {
			padding: 2px 4px;
		}

		.btn-toolbar {
			padding: 5px 8px;
			font-size: 0.75rem;
			border: 1px solid var(--border);
			background: transparent;
		}
	}

	@media (max-width: 768px) and (orientation: landscape) {
		.sidebar {
			height: 100vh !important;
			height: 100dvh !important;
			overflow: hidden;
			display: flex !important;
			flex-direction: column !important;
		}
		
		.sidebar-header {
			flex-shrink: 0;
			margin-bottom: 2px;
			padding: 4px;
		}
		
		.sidebar-header h2 {
			font-size: 0.75rem;
			margin: 0;
		}
		
		.category-list {
			flex: 1 1 auto !important;
			min-height: 0 !important;
			overflow-y: scroll !important;
			-webkit-overflow-scrolling: touch !important;
			margin-bottom: 2px;
		}
		
		.category-item {
			padding: 6px;
			margin: 1px 0;
			font-size: 0.85rem;
		}
		
		.sidebar .btn {
			flex-shrink: 0;
			margin-top: 2px;
			padding: 4px 8px;
			font-size: 0.7rem;
		}
		
		.sidebar hr {
			margin: 2px 0;
		}

		header {
			padding: 2px 4px;
		}

		h1 {
			font-size: 1rem;
		}

		.map-toolbar {
			padding: 1px 2px;
		}

		.btn-toolbar {
			padding: 4px 8px;
			font-size: 0.75rem;
		}
	}

	/* Page Navigation */
	.page {
		display: none;
		flex: 1;
		flex-direction: column;
		overflow: hidden;
		background: var(--bg);
		justify-content: flex-start;
	}

	.page.active {
		display: flex;
	}

	.page-header {
		background: var(--bg);
		border-bottom: 2px solid var(--border);
		padding: 16px;
		flex-shrink: 0;
		position: relative;
		z-index: 32;
	}

	.page-header h2 {
		margin: 0;
		font-size: 1.25rem;
	}

	.page-content {
		display: flex;
		flex: 1;
		flex-direction: column;
		overflow-y: auto;
		-webkit-overflow-scrolling: touch;
		padding: 16px;
		background: var(--bg);
		justify-content: flex-start;
		align-items: stretch;
	}

	/* Search Page */
	.search-page-content {
		display: flex;
		flex: 1;
		flex-direction: column;
		padding: 0 !important;
		background: var(--bg);
		justify-content: flex-start;
		align-items: stretch;
	}

	.search-hero {
		background: var(--bg);
		border-bottom: 2px solid var(--border);
		padding: 40px 20px;
		text-align: center;
		color: var(--fg);
		flex-shrink: 0;
		width: 100%;
	}

	.search-hero h1 {
		margin: 0 0 30px;
		font-size: 1.5rem;
		font-weight: 600;
		letter-spacing: 0;
		color: var(--fg);
	}

	.search-bar-container {
		width: 50%;
		margin: 0 auto;
	}

	.search-input-wrapper {
		display: flex;
		gap: 8px;
		background: var(--bg);
		border-radius: 6px;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
		overflow: visible;
		align-items: stretch;
		border: 2px solid var(--border);
	}

	.search-input-wrapper:focus-within {
		border-color: var(--link);
		box-shadow: 0 2px 12px rgba(0, 0, 0, 0.12);
	}

	.search-input-hero {
		flex: 1;
		padding: 16px 20px;
		border: none;
		font-size: 1.05rem;
		background: transparent;
		color: var(--fg);
		outline: none;
		font-family: inherit;
		min-width: 0;
	}

	.search-input-hero::placeholder {
		color: var(--muted-fg);
	}

	.search-input-hero:focus {
		outline: none;
	}

	.search-type-dropdown {
		padding: 12px 40px 12px 12px;
		border: none;
		border-left: 1px solid var(--border);
		font-size: 0.875rem;
		background: transparent;
		color: var(--fg);
		cursor: pointer;
		font-family: inherit;
		font-weight: 500;
		min-width: 120px;
		outline: none;
		text-align: left;
		flex-shrink: 0;
		appearance: none;
		-webkit-appearance: none;
		-moz-appearance: none;
		background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%230ea5e9' stroke-width='2'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
		background-repeat: no-repeat;
		background-position: right 8px center;
		background-size: 20px;
		padding-right: 32px;
	}

	.search-type-dropdown:hover {
		background: var(--hover);
	}

	.search-type-dropdown:focus {
		outline: none;
		background: var(--hover);
	}

	/* Search Results Container */
	#search-results {
		padding: 30px 20px;
		background: var(--bg);
		flex: 1;
	}

	.search-results {
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: start;
		min-height: 400px;
		gap: 12px;
		max-width: 1200px;
		margin: 0 auto;
	}

	.search-results:has(> :not(.empty-state)) {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
		align-items: start;
		justify-content: start;
		min-height: auto;
	}

	.search-result-item {
		padding: 12px;
		border: 1px solid var(--border);
		border-radius: 6px;
		cursor: pointer;
		transition: all 0.2s;
		background: var(--bg);
	}

	.search-result-item:hover {
		background: var(--hover);
		border-color: var(--link);
		transform: translateY(-2px);
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
	}

	.search-result-item h4 {
		margin: 0 0 8px;
		font-size: 1rem;
		color: var(--link);
	}

	.search-result-item p {
		margin: 4px 0;
		font-size: 0.875rem;
	}

	.search-result-description {
		margin-top: 12px;
		padding-top: 12px;
		border-top: 1px solid var(--border);
		font-size: 0.875rem;
		line-height: 1.5;
	}

	.search-result-description p {
		margin: 8px 0;
	}

	.search-result-description p:first-child {
		margin-top: 0;
	}

	/* Add Item Modal Styles */
	.modal-body {
		display: flex;
		flex-direction: column;
		gap: 16px;
		flex: 1;
		min-height: 0;
	}

	.modal-body .search-input {
		padding: 12px 16px;
		border: 2px solid var(--border);
		border-radius: 6px;
		background: var(--bg);
		color: var(--fg);
		font-size: 1rem;
		font-family: inherit;
		outline: none;
		transition: all 0.2s;
		width: 100%;
	}

	.modal-body .search-input:focus {
		border-color: var(--link);
		box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.1);
	}

	.modal-body .search-input::placeholder {
		color: var(--muted-fg);
	}

	.add-item-results {
		flex: 1;
		overflow-y: auto;
		-webkit-overflow-scrolling: touch;
		display: flex;
		flex-direction: column;
		gap: 8px;
		min-height: 200px;
		padding-right: 8px;
	}

	.add-item-result {
		padding: 12px;
		border: 1px solid var(--border);
		border-radius: 6px;
		background: var(--hover);
		display: flex;
		justify-content: space-between;
		align-items: center;
		gap: 12px;
		transition: all 0.2s;
	}

	.add-item-result:hover {
		background: var(--bg);
		border-color: var(--link);
	}

	.add-item-result-name {
		flex: 1;
		font-weight: 500;
		color: var(--fg);
	}

	.add-item-result-qty {
		display: flex;
		align-items: center;
		gap: 8px;
	}

	.add-item-qty-input {
		width: 60px;
		padding: 6px 8px;
		border: 1px solid var(--border);
		border-radius: 4px;
		background: var(--bg);
		color: var(--fg);
		font-size: 0.875rem;
		text-align: center;
		outline: none;
	}

	.add-item-qty-input:focus {
		border-color: var(--link);
	}

	.btn-add-to-inventory {
		padding: 6px 12px;
		background: var(--link);
		color: var(--bg);
		border: none;
		border-radius: 4px;
		font-weight: 600;
		font-size: 0.875rem;
		cursor: pointer;
		transition: all 0.2s;
		white-space: nowrap;
	}

	.btn-add-to-inventory:hover {
		filter: brightness(1.1);
		transform: translateY(-1px);
	}

	.equipment-loading {
		text-align: center;
		padding: 24px;
		color: var(--muted-fg);
		font-size: 0.875rem;
	}

	.search-result-item p {
		margin: 4px 0;
		font-size: 0.875rem;
		color: var(--muted-fg);
	}

	@media (max-width: 768px) {
		.search-hero {
			padding: 24px 12px;
		}

		.search-hero h1 {
			font-size: 1.25rem;
			margin-bottom: 20px;
		}

		.search-bar-container {
			width: 100%;
		}

		.search-input-wrapper {
			flex-direction: row;
			gap: 8px;
		}

		.search-input-hero {
			padding: 16px 18px;
			font-size: 18px;
			flex: 3;
		}

		.search-type-dropdown {
			padding: 14px 32px 14px 12px;
			font-size: 14px;
			border-left: 1px solid var(--border);
			min-width: 85px;
			flex-shrink: 0;
		}

		#search-results {
			padding: 20px 12px;
		}

		.search-results {
			max-width: 100%;
			width: 100%;
			margin: 0;
		}

		.search-results:has(> :not(.empty-state)) {
			grid-template-columns: 1fr;
			gap: 10px;
		}

		.search-result-item {
			width: 100%;
			box-sizing: border-box;
		}
	}

	/* Party Inventory Page */
	.inventory-sections {
		display: flex;
		flex-direction: column;
		gap: 24px;
	}

	.currency-section {
		background: linear-gradient(135deg, rgba(147, 197, 253, 0.05) 0%, rgba(196, 181, 253, 0.05) 100%);
		border: 2px solid var(--border);
		border-radius: 12px;
		padding: 24px;
		margin-bottom: 24px;
	}

	.currency-section h3 {
		margin: 0 0 20px;
		font-size: 1.2rem;
		font-weight: 600;
		color: var(--link);
	}

	.currency-inputs {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
		gap: 16px;
	}

	.currency-item {
		display: flex;
		flex-direction: column;
		gap: 8px;
		padding: 12px;
		background: var(--bg);
		border-radius: 8px;
		border: 1px solid var(--border);
		transition: all 0.2s;
	}

	.currency-item:hover {
		border-color: var(--link);
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
		transform: translateY(-2px);
	}

	.currency-item label {
		font-weight: 600;
		font-size: 0.875rem;
		display: flex;
		align-items: center;
		gap: 8px;
		color: var(--muted-fg);
		letter-spacing: 0.02em;
	}

	.coin-icon {
		display: inline-flex;
		align-items: center;
		justify-content: center;
		width: 20px;
		height: 20px;
		font-size: 1.1rem;
		line-height: 1;
	}

	.coin-platinum {
		color: #e8e8e8;
		text-shadow: 0 0 4px rgba(200, 200, 200, 0.5);
	}

	.coin-gold {
		color: #ffd700;
		text-shadow: 0 0 4px rgba(255, 215, 0, 0.5);
	}

	.coin-silver {
		color: #c0c0c0;
		text-shadow: 0 0 4px rgba(192, 192, 192, 0.5);
	}

	.coin-copper {
		color: #b87333;
		text-shadow: 0 0 4px rgba(184, 115, 51, 0.5);
	}

	.currency-input {
		padding: 12px;
		border: 2px solid var(--border);
		border-radius: 6px;
		font-size: 1rem;
		font-weight: 600;
		background: var(--hover);
		color: var(--fg);
		transition: all 0.2s;
		text-align: center;
	}

	.currency-input:focus {
		outline: none;
		border-color: var(--link);
		box-shadow: 0 0 0 3px rgba(147, 197, 253, 0.1);
		background: var(--bg);
	}

	.currency-input:focus {
		outline: none;
		border-color: var(--link);
	}

	.items-section {
		border: 2px solid var(--border);
		border-radius: 8px;
		padding: 16px;
	}

	.items-header {
		display: flex;
		justify-content: space-between;
		align-items: center;
		margin-bottom: 16px;
	}

	.items-header h3 {
		margin: 0;
		font-size: 1.1rem;
	}

	.btn-add-item {
		padding: 10px 16px;
		background: #000000;
		color: #ffffff;
		border: none;
		border-radius: 6px;
		font-weight: 600;
		font-size: 0.875rem;
		cursor: pointer;
		transition: all 0.2s;
	}

	.btn-add-item:hover {
		background: #1a1a1a;
		transform: translateY(-2px);
	}

	@media (prefers-color-scheme: dark) {
		.btn-add-item {
			background: #ffffff;
			color: #000000;
		}

		.btn-add-item:hover {
			background: #e0e0e0;
		}
	}

	.inventory-items {
		display: grid;
		grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
		gap: 12px;
	}

	.inventory-item {
		display: flex;
		flex-direction: column;
		padding: 14px;
		border: 1px solid var(--border);
		border-radius: 8px;
		background: var(--hover);
		transition: all 0.2s;
	}

	.inventory-item:hover {
		border-color: var(--link);
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
	}

	.inventory-item-info h4 {
		margin: 0 0 8px;
		font-size: 1rem;
		word-break: break-word;
	}

	.inventory-item-info p {
		margin: 0 0 8px;
		font-size: 0.85rem;
		color: var(--muted-fg);
		line-height: 1.4;
	}

	.inventory-item-controls {
		display: flex;
		gap: 8px;
		align-items: center;
		margin-top: auto;
		padding-top: 12px;
		border-top: 1px solid var(--border);
	}

	.inventory-item-qty {
		display: flex;
		align-items: center;
		gap: 4px;
		border: 1px solid var(--border);
		border-radius: 4px;
		padding: 2px 4px;
		background: rgba(0, 0, 0, 0.05);
	}

	.inventory-qty-btn {
		background: none;
		border: none;
		color: var(--fg);
		cursor: pointer;
		font-size: 0.9rem;
		width: 18px;
		height: 18px;
		display: flex;
		align-items: center;
		justify-content: center;
		padding: 0;
		transition: color 0.2s;
	}

	.inventory-qty-btn:hover {
		color: var(--link);
	}

	.inventory-qty-display {
		min-width: 24px;
		text-align: center;
		font-weight: 600;
		font-size: 0.9rem;
	}

	.btn-remove-item {
		background: none;
		border: 1px solid var(--border);
		color: var(--fg);
		padding: 6px 10px;
		border-radius: 4px;
		cursor: pointer;
		font-size: 0.8rem;
		transition: all 0.2s;
		flex: 1;
		text-align: center;
	}

	.btn-remove-item:hover {
		background: #dc2626;
		color: white;
		border-color: #dc2626;
	}

	.empty-state {
		text-align: center;
		padding: 32px 16px;
		color: var(--muted-fg);
	}

	@media (prefers-color-scheme: dark) {
		.nav-btn:hover,
		.nav-btn.active {
			background: var(--hover);
			border-color: var(--link);
			color: var(--link);
		}
	}

	@media (max-width: 768px) {
		.page-content {
			padding: 12px;
		}

		.search-results {
			grid-template-columns: 1fr;
		}

		.currency-inputs {
			grid-template-columns: 1fr;
		}

		.items-header {
			flex-direction: column;
			align-items: flex-start;
			gap: 12px;
		}

		.btn-add-item {
			width: 100%;
		}

		.inventory-item {
			flex-direction: column;
			align-items: flex-start;
			gap: 12px;
		}

		.inventory-item-controls {
			width: 100%;
			justify-content: space-between;
		}

		.modal-content {
			max-width: 100%;
			max-height: 90vh;
			max-height: 90dvh;
			padding: 20px;
		}

		.nav-btn {
			padding: 6px 10px;
			font-size: 0.75rem;
		}

		.page {
			left: 0;
			right: 0;
		}
	}

	@media (prefers-reduced-motion: reduce) {
		.btn,
		.category-item,
		.map-location,
		.sidebar,
		.search-result-item,
		.inventory-item {
			transition: none;
		}

		.btn:hover {
			-webkit-transform: none;
			transform: none;
		}
	}
	</style>
	</head>
	<body>
		<!-- Google Tag Manager (noscript) -->
		<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W8RGXCTR"
		height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
		<!-- End Google Tag Manager (noscript) -->

		<a href="#main-content" class="skip-link">Skip to main content</a>

		<header>
			<button id="btn-menu" aria-label="Toggle menu">â˜°</button>
			<h1 id="page-title" style="cursor: pointer;">RPG Campaign Tracker</h1>
			<button class="btn-menu-close hidden" id="btn-menu-close" aria-label="Close menu">âœ•</button>
			<nav class="nav-links">
				<button class="nav-btn" data-page="home">Home</button>
				<button class="nav-btn" data-page="map">World Map</button>
				<button class="nav-btn" data-page="search">Search</button>
				<button class="nav-btn" data-page="inventory">Party Inventory</button>
			</nav>
		</header>
		<div class="mobile-overlay" id="mobile-overlay"></div>

		<!-- Container -->
		<div class="container">
			<!-- Sidebar -->
			<aside class="sidebar" id="sidebar">
				<div class="sidebar-header">
					<h2>Categories</h2>
					<button class="sidebar-close" id="btn-close-sidebar" aria-label="Close menu">&times;</button>
				</div>
				<ul class="category-list">
					<li class="category-item active" data-category="all">
						<span>All</span>
						<span class="badge" id="badge-all">0</span>
					</li>
					<li class="category-item" data-category="locations">
						<span>Locations</span>
						<span class="badge" id="badge-locations">0</span>
					</li>
					<li class="category-item" data-category="npcs">
						<span>NPCs</span>
						<span class="badge" id="badge-npcs">0</span>
					</li>
					<li class="category-item" data-category="items">
						<span>Items</span>
						<span class="badge" id="badge-items">0</span>
					</li>
					<li class="category-item" data-category="events">
						<span>Events</span>
						<span class="badge" id="badge-events">0</span>
					</li>
				</ul>
				<button class="btn" id="btn-add-new">+ Add New</button>
				<hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border);">
				
				<!-- Search Categories Section -->
				<div style="margin-bottom: 16px;">
					<h3 style="margin: 0 0 8px; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--muted-fg);">Rules Search</h3>
					<input type="text" id="search-category-filter" placeholder="Filter searches..." autocomplete="off" style="width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--fg); font-size: 0.875rem; box-sizing: border-box; margin-bottom: 8px;">
				</div>
				<ul class="category-list search-category-list" id="search-category-list" style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border); border-radius: 4px; padding: 4px;">
					<li class="category-item search-category-item" data-search-type="equipment">
						<span>Equipment</span>
					</li>
					<li class="category-item search-category-item" data-search-type="spells">
						<span>Spells</span>
					</li>
					<li class="category-item search-category-item" data-search-type="monsters">
						<span>Monsters</span>
					</li>
					<li class="category-item search-category-item" data-search-type="classes">
						<span>Classes</span>
					</li>
					<li class="category-item search-category-item" data-search-type="races">
						<span>Races</span>
					</li>
					<li class="category-item search-category-item" data-search-type="skills">
						<span>Skills</span>
					</li>
					<li class="category-item search-category-item" data-search-type="conditions">
						<span>Conditions</span>
					</li>
					<li class="category-item search-category-item" data-search-type="damage-types">
						<span>Damage Types</span>
					</li>
					<li class="category-item search-category-item" data-search-type="ability-scores">
						<span>Ability Scores</span>
					</li>
					<li class="category-item search-category-item" data-search-type="languages">
						<span>Languages</span>
					</li>
					<li class="category-item search-category-item" data-search-type="traits">
						<span>Traits</span>
					</li>
					<li class="category-item search-category-item" data-search-type="features">
						<span>Features</span>
					</li>
					<li class="category-item search-category-item" data-search-type="proficiencies">
						<span>Proficiencies</span>
					</li>
					<li class="category-item search-category-item" data-search-type="subclasses">
						<span>Subclasses</span>
					</li>
					<li class="category-item search-category-item" data-search-type="subraces">
						<span>Subraces</span>
					</li>
					<li class="category-item search-category-item" data-search-type="magic-schools">
						<span>Magic Schools</span>
					</li>
					<li class="category-item search-category-item" data-search-type="weapon-properties">
						<span>Weapon Properties</span>
					</li>
					<li class="category-item search-category-item" data-search-type="equipment-categories">
						<span>Equipment Categories</span>
					</li>
				</ul>
				
				<hr style="margin: 20px 0; border: none; border-top: 1px solid var(--border);">
				<label class="btn" id="btn-upload-map-label">
					Upload Map
					<input type="file" id="btn-upload-map" accept=".jpg,.jpeg,.png,.gif,.webp,image/*" style="display: none;">
				</label>
				<button class="btn" id="btn-export">Export Data</button>
				<label class="btn" id="btn-import-label">
					Import Data
					<input type="file" id="btn-import" accept=".json" style="display: none;">
				</label>
			</aside>

		<!-- Map Container -->
		<main class="map-container" id="main-content">
				<div class="map-toolbar">
					<button class="btn-toolbar" id="btn-zoom-in">Zoom In</button>
					<button class="btn-toolbar" id="btn-zoom-out">Zoom Out</button>
					<button class="btn-toolbar" id="btn-reset-view">Reset View</button>
				</div>
				<div class="map-view" id="map-view">
					<svg class="map-svg" id="map-svg" viewBox="0 0 1000 600" preserveAspectRatio="xMidYMid slice">
						<!-- Map background -->
						<defs>
							<pattern id="grid" width="50" height="50" patternUnits="userSpaceOnUse">
								<path d="M 50 0 L 0 0 0 50" fill="none" stroke="rgba(100,100,100,0.1)" stroke-width="1"/>
							</pattern>
						</defs>
						<rect width="1000" height="600" fill="url(#grid)"/>
						
						<!-- Example locations - will be dynamically populated -->
						<g id="locations-layer"></g>
					</svg>
				</div>
			</div>

			<!-- Search Page -->
			<div class="page hidden" id="search-page">
				<div class="page-content search-page-content">
					<div class="search-hero">
						<h1>Rules Search</h1>
						<div class="search-bar-container">
							<div class="search-input-wrapper">
								<input type="text" id="search-query" class="search-input-hero" placeholder="Enter text" autocomplete="off">
								<select id="search-type" class="search-type-dropdown">
									<option value="equipment">Equipment</option>
									<option value="spells">Spells</option>
									<option value="monsters">Monsters</option>
									<option value="classes">Classes</option>
									<option value="races">Races</option>
									<option value="skills">Skills</option>
									<option value="conditions">Conditions</option>
									<option value="damage-types">Damage Types</option>
									<option value="ability-scores">Ability Scores</option>
									<option value="languages">Languages</option>
									<option value="traits">Traits</option>
									<option value="features">Features</option>
									<option value="proficiencies">Proficiencies</option>
									<option value="subclasses">Subclasses</option>
									<option value="subraces">Subraces</option>
									<option value="magic-schools">Magic Schools</option>
									<option value="weapon-properties">Weapon Properties</option>
									<option value="equipment-categories">Equipment Categories</option>
								</select>
							</div>
						</div>
					</div>
					<div class="search-results" id="search-results">
						<div class="empty-state">Use the dropdown on the right to choose which part of the rules you would like to search.</div>
					</div>
				</div>
			</div>

			<!-- Party Inventory Page -->
			<div class="page hidden" id="inventory-page">
				<div class="page-header">
					<h2>Party Inventory</h2>
				</div>
				<div class="page-content">
					<div class="inventory-sections">
						<!-- Currency Section -->
						<div class="currency-section">
							<h3>ðŸ’° Currency</h3>
							<div class="currency-inputs">
								<div class="currency-item">
									<label><span class="coin-icon coin-platinum">â¬¤</span> Platinum (pp)</label>
									<input type="number" id="currency-platinum" class="currency-input" min="0" value="0">
								</div>
								<div class="currency-item">
									<label><span class="coin-icon coin-gold">â¬¤</span> Gold (gp)</label>
									<input type="number" id="currency-gold" class="currency-input" min="0" value="0">
								</div>
								<div class="currency-item">
									<label><span class="coin-icon coin-silver">â¬¤</span> Silver (sp)</label>
									<input type="number" id="currency-silver" class="currency-input" min="0" value="0">
								</div>
								<div class="currency-item">
									<label><span class="coin-icon coin-copper">â¬¤</span> Copper (cp)</label>
									<input type="number" id="currency-copper" class="currency-input" min="0" value="0">
								</div>
							</div>
						</div>

						<!-- Items Section -->
						<div class="items-section">
							<div class="items-header">
								<h3>Items</h3>
								<button class="btn-add-item" id="btn-add-item">+ Add Item</button>
							</div>
							<div class="inventory-items" id="inventory-items">
								<div class="empty-state">No items in inventory. Click "Add Item" to begin.</div>
							</div>
						</div>
					</div>

					<!-- Add Item Modal -->
					<div class="modal hidden" id="add-item-modal">
						<div class="modal-content">
							<div class="modal-header">
								<h3>Add Equipment to Inventory</h3>
								<button class="btn-close" id="btn-close-add-item-modal">&times;</button>
							</div>
							<div class="modal-body">
								<input type="text" id="add-item-search" class="search-input" placeholder="Search equipment..." autocomplete="off">
								<div class="add-item-results" id="add-item-results">
									<div class="empty-state">Start typing to search equipment</div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</main>

		<!-- Detail Panel -->
		<aside class="detail-panel hidden" id="detail-panel">
			<div class="detail-header">
				<h2 id="detail-title">Locations</h2>
				<button class="btn-close" id="btn-close-detail" aria-label="Close details">&times;</button>
			</div>
			<div id="detail-content">
				<div class="empty-state">
					<p>Click on a location on the map to view details</p>
				</div>
			</div>
		</aside>

		<!-- Equipment Search Panel -->
		<aside class="detail-panel hidden equipment-panel" id="equipment-panel">
			<div class="detail-header">
				<div style="display: flex; align-items: center; gap: 8px;">
					<h2 style="margin: 0;">Equipment Search</h2>
					<span class="badge" id="badge-equipment-count">0</span>
				</div>
				<button class="btn-close" id="btn-close-equipment" aria-label="Close equipment">&times;</button>
			</div>
			<div class="equipment-search-box">
				<input type="text" id="equipment-search" placeholder="Search equipment..." autocomplete="off">
			</div>
			<div class="equipment-results" id="equipment-results">
				<div class="equipment-loading">Loading equipment data...</div>
			</div>
		</aside>

		<!-- Add New Modal -->
		<div class="modal" id="modal-add">
			<div class="modal-content">
				<div class="modal-header">
					<h2>Add New</h2>
					<button class="btn-close" id="btn-close-modal" aria-label="Close modal">&times;</button>
				</div>
				<form id="form-add">
					<div class="form-group">
						<label for="add-type">Type</label>
						<select id="add-type" name="type" required>
							<option value="">Select type...</option>
							<option value="location">Location</option>
							<option value="npc">NPC</option>
							<option value="item">Item</option>
							<option value="event">Event</option>
						</select>
					</div>
					<div id="form-fields"></div>
					<div class="form-actions">
						<button type="button" class="btn btn-secondary" id="btn-cancel">Cancel</button>
						<button type="submit" class="btn">Save</button>
					</div>
				</form>
			</div>
		</div>

		<script>
			// Data Store
			class DataStore {
				constructor() {
					this.dataFile = '/rpg-data.json';
					this.data = {
						locations: [],
						npcs: [],
						items: [],
						events: []
					};
					this.loaded = false;
				}

				async load() {
					try {
						const response = await fetch(this.dataFile);
						if (response.ok) {
							this.data = await response.json();
							this.loaded = true;
							this.updateBadges();
							
							// Load static map if no custom map is set
							if (!this.data.mapSvg) {
								await this.loadStaticMap();
							}
							
							return true;
						}
					} catch (e) {
						console.error('Error loading data from JSON:', e);
					}
					
					// Fallback to empty state
					this.data = {
						locations: [],
						npcs: [],
						items: [],
						events: [],
						mapSvg: null
					};
					this.loaded = true;
					this.updateBadges();
					
					// Load static map
					await this.loadStaticMap();
					
					return false;
				}

				async loadStaticMap() {
					// Try to load PNG first
					try {
					const response = await fetch('/map.png?t=' + Date.now());
					if (response.ok) {
						const pngBlob = await response.blob();
						const pngUrl = URL.createObjectURL(pngBlob);
						this.data.mapSvg = pngUrl;
						this.data.mapType = 'raster';
						this.data.mapWidth = 11548;
						this.data.mapHeight = 7724;
						this.data.isStaticMap = true;
						return true;
					}
				} catch (e) {
					console.error('[ERROR] Failed to load map.png:', e);
				}

				// Fallback to grid if map.png doesn't exist
				this.data.mapSvg = null;
				this.data.mapType = 'grid';
				return false;
			}

		save() {
			// Note: This doesn't save to the server automatically
				this.updateBadges();
			}

			exportData() {
					const dataStr = JSON.stringify(this.data, null, 2);
					const dataBlob = new Blob([dataStr], { type: 'application/json' });
					const url = URL.createObjectURL(dataBlob);
					const link = document.createElement('a');
					link.href = url;
					link.download = 'rpg-data.json';
					document.body.appendChild(link);
					link.click();
					document.body.removeChild(link);
					URL.revokeObjectURL(url);
				}

				async importData(file) {
					try {
						const text = await file.text();
						const imported = JSON.parse(text);
						
						// Validate structure
						if (imported.locations && imported.npcs && imported.items && imported.events) {
							this.data = imported;
							this.updateBadges();
							return true;
						} else {
							throw new Error('Invalid data structure');
						}
					} catch (e) {
						console.error('Error importing data:', e);
						alert('Error importing file. Please ensure it\'s a valid rpg-data.json file.');
						return false;
					}
				}

				async uploadMap(file) {
					try {
					// Handle raster images only (JPG, PNG, etc.)
					if (file.type.startsWith('image/')) {
						const reader = new FileReader();
						
						return new Promise((resolve, reject) => {
							reader.onload = (e) => {
								const img = new Image();
								img.onload = () => {
									this.data.mapSvg = e.target.result; // Store as data URL
									this.data.mapType = 'raster';
									this.data.isStaticMap = false;
									this.data.mapWidth = img.width;
									this.data.mapHeight = img.height;
									resolve(true);
								};
								img.onerror = () => {
									reject(new Error('Failed to load image'));
								};
								img.src = e.target.result;
							};
							reader.onerror = () => reject(new Error('Failed to read file'));
							reader.readAsDataURL(file);
						});
					} else {
						throw new Error('Only image files (PNG, JPG, etc.) are supported.');
					}
				} catch (e) {
					console.error('Error uploading map:', e);
					alert('Error uploading map: ' + e.message);
					return false;
				}
			}

			add(type, item) {
				if (!this.data[type]) {
					this.data[type] = [];
				}
				// Generate a proper integer ID
				const maxId = this.data[type].reduce((max, item) => 
					Math.max(max, item.id || 0), 0);
				item.id = maxId + 1;
				item.createdAt = new Date().toISOString();
				this.data[type].push(item);
				this.save();
				return item;
			}

				get(type, id) {
					return this.data[type]?.find(item => item.id === id);
				}

				getAll(type) {
					return this.data[type] || [];
				}

				update(type, id, updates) {
					const index = this.data[type]?.findIndex(item => item.id === id);
					if (index !== -1) {
						this.data[type][index] = { ...this.data[type][index], ...updates };
						this.save();
						return this.data[type][index];
					}
					return null;
				}

				delete(type, id) {
					if (this.data[type]) {
						this.data[type] = this.data[type].filter(item => item.id !== id);
						this.save();
					}
				}

				updateBadges() {
					document.getElementById('badge-locations').textContent = this.data.locations.length;
					document.getElementById('badge-npcs').textContent = this.data.npcs.length;
					document.getElementById('badge-items').textContent = this.data.items.length;
					document.getElementById('badge-events').textContent = this.data.events.length;
					
					const total = this.data.locations.length + this.data.npcs.length + 
						              this.data.items.length + this.data.events.length;
					document.getElementById('badge-all').textContent = total;
				}

				// Equipment API caching with local file fallback
				async getEquipmentList() {
					const cacheKey = 'dnd5e_equipment_cache';
					const cacheTTL = 24 * 60 * 60 * 1000; // 24 hours in milliseconds
					
					// Check if cached data exists and is fresh
					const cached = localStorage.getItem(cacheKey);
					const cacheTime = localStorage.getItem(cacheKey + '_time');
					
					if (cached && cacheTime) {
						const age = Date.now() - parseInt(cacheTime);
						if (age < cacheTTL) {
							return JSON.parse(cached);
						}
					}
					
					// Try to load from local file first (updated daily by GitHub Actions)
					try {
					const response = await fetch('/data/equipment.json');
					if (response.ok) {
						const data = await response.json();
						// Cache the data
						localStorage.setItem(cacheKey, JSON.stringify(data));
						localStorage.setItem(cacheKey + '_time', Date.now().toString());
						return data;
					}
				} catch (error) {
					console.debug('Could not load local equipment file, falling back to API');
				}
				
				// Fallback to API if local file not available
				try {
					const response = await fetch('https://www.dnd5eapi.co/api/2014/equipment');
					if (!response.ok) throw new Error('API request failed');
					
					const data = await response.json();
					
					// Cache the data
					localStorage.setItem(cacheKey, JSON.stringify(data));
					localStorage.setItem(cacheKey + '_time', Date.now().toString());
					
					return data;
				} catch (error) {
					console.error('Error fetching equipment data from API:', error);
					
					// Return cached data if available, even if expired
					if (cached) {
						console.warn('Using expired cache due to API error');
						return JSON.parse(cached);
					}
					
					throw error;
				}
			}

			async getEquipmentDetail(url) {
				try {
					// Construct the full URL
					const fullUrl = `https://www.dnd5eapi.co${url}`;
					console.log('[DEBUG] Fetching equipment detail from:', fullUrl);
					
					const response = await fetch(fullUrl, {
						method: 'GET',
						headers: {
							'Accept': 'application/json'
						},
						mode: 'cors',
						credentials: 'omit'
					});
					console.log('[DEBUG] Response status:', response.status, response.statusText);
					
					if (!response.ok) {
						throw new Error(`API returned ${response.status}: ${response.statusText}`);
					}
					
					const data = await response.json();
					console.log('[DEBUG] Equipment detail loaded:', data);
					return data;
				} catch (error) {
					console.error('[ERROR] Failed to fetch equipment details:', error.message, error);
					throw error;
				}
			}
		}

		// Load data and initialize app
		async function initApp() {
		const mapView = document.getElementById('map-view');
		
		// CRITICAL: Absolute safety net - remove loading after 2 seconds NO MATTER WHAT
		const safetyTimeout = setTimeout(() => {
			console.error('[CRITICAL] Safety timeout triggered - forcing loading state off');
			mapView.classList.remove('loading');
			mapView.classList.add('ready');
		}, 2000);
		
		try {
			console.log('[DEBUG] initApp starting');
			await store.load();
			console.log('[DEBUG] store loaded, calling renderMap');
			
			if (mapController) {
				mapController.renderMap();
				clearTimeout(safetyTimeout);
			} else {
				console.error('[ERROR] mapController not defined');
				mapView.classList.remove('loading');
				mapView.classList.add('ready');
				clearTimeout(safetyTimeout);
			}
		} catch (e) {
			console.error('[ERROR] initApp failed:', e);
			mapView.classList.remove('loading');
			mapView.classList.add('ready');
			clearTimeout(safetyTimeout);
		}
	}
			const store = new DataStore();

			// Map Controller
			class MapController {
				constructor() {
					this.svg = document.getElementById('map-svg');
					if (!this.svg) {
						console.error('[ERROR] map-svg element not found');
						return;
					}
				this.locationsLayer = null; // Will be set in renderMap
					this.transformTimeout = null;
					this.willChangeTimeout = null;
					this.isTransforming = false;
					this.lastDistance = 0;
					this.lastScale = 1;

					this.initializeEvents();
				}

				initializeEvents() {
					// Zoom controls
					document.getElementById('btn-zoom-in').addEventListener('click', () => this.zoom(1.2));
					document.getElementById('btn-zoom-out').addEventListener('click', () => this.zoom(0.8));
					document.getElementById('btn-reset-view').addEventListener('click', () => this.resetView());

					// Mouse pan controls
					this.svg.addEventListener('mousedown', (e) => this.startDrag(e), { passive: true });
					this.svg.addEventListener('mousemove', (e) => this.drag(e), { passive: false });
					document.addEventListener('mouseup', (e) => this.endDrag(e), { passive: true });

					// Touch support for mobile panning and pinch zoom
					this.svg.addEventListener('touchstart', (e) => this.handleTouchStart(e), { passive: true });
					this.svg.addEventListener('touchmove', (e) => this.handleTouchMove(e), { passive: false });
					this.svg.addEventListener('touchend', (e) => this.handleTouchEnd(e), { passive: true });
				}

		zoom(factor) {
				// Get the viewport center
				const mapView = this.svg.parentElement;
				const centerX = mapView.clientWidth / 2;
				const centerY = mapView.clientHeight / 2;
				
				// Calculate the position of the center point in map coordinates
				const mapCenterX = (centerX - this.translateX) / this.scale;
				const mapCenterY = (centerY - this.translateY) / this.scale;
				
				// Apply zoom
				this.scale *= factor;
				this.scale = Math.max(0.5, Math.min(5, this.scale));
				
				// Adjust translation to keep the center point in the same visual location
				this.translateX = centerX - mapCenterX * this.scale;
				this.translateY = centerY - mapCenterY * this.scale;
				
				this.updateTransform();
				
				// Throttle rapid subsequent zooms to prevent overwhelming
				if (this.transformTimeout) return;
				
				this.transformTimeout = setTimeout(() => {
					this.transformTimeout = null;
				}, 50); // Reduced to 50ms for better responsiveness
			}

			resetView() {
				this.scale = 1;
				this.translateX = 0;
				this.translateY = 0;
				this.updateTransform();
			}

			startDrag(e) {
				this.isDragging = true;
				this.startX = e.clientX - this.translateX;
				this.startY = e.clientY - this.translateY;
				this.svg.style.cursor = 'grabbing';
		}

		drag(e) {
			if (!this.isDragging) return;
			
			// Update position values immediately
			this.translateX = e.clientX - this.startX;
			this.translateY = e.clientY - this.startY;
			
			// Call updateTransform without RAF for more responsive feel
			this.updateTransformDirect();
		}

	endDrag(e) {
		this.isDragging = false;
		this.svg.style.cursor = 'grab';
	}

	updateTransformDirect() {
		// Direct update without RAF for drag responsiveness
		const target = this.mainGroup || this.svg;
		target.style.transform = 
			`translate3d(${this.translateX}px, ${this.translateY}px, 0) scale(${this.scale})`;
	}

	handleTouchStart(e) {
		if (e.touches.length === 1) {
			// Single touch - pan only, let browser handle multi-touch zoom
			this.startDrag(e.touches[0]);
		} else {
			// Two or more fingers - stop panning, let browser handle pinch zoom natively
			this.isDragging = false;
		}
	}

		handleTouchMove(e) {
			if (e.touches.length === 1) {
				// Single touch - pan
				e.preventDefault();
				this.drag(e.touches[0]);
			} else {
				// Two or more fingers - don't prevent default, let browser handle zoom
				// Do nothing - allow native pinch zoom
			}
		}

		handleTouchEnd(e) {
			if (e.touches.length < 2) {
				// Exiting multi-touch
				this.lastDistance = 0;
				if (e.touches.length === 1) {
					// Back to single touch pan
					this.startDrag(e.touches[0]);
				} else {
					// No more touches
					this.endDrag(e);
				}
			}
		}

		updateTransform() {
					// Use RAF for smooth 60fps updates
					if (this.rafId) {
						cancelAnimationFrame(this.rafId);
					}
					
					this.rafId = requestAnimationFrame(() => {
						const target = this.mainGroup || this.locationsLayer;
						if (!target) return;
						
						// Apply transform with no transition for instant feedback
						target.style.transform = 
							`translate3d(${this.translateX}px, ${this.translateY}px, 0) scale(${this.scale})`;
						
						// Mark as transforming and set will-change
						if (!this.isTransforming) {
							this.isTransforming = true;
							target.style.willChange = 'transform';
						}
						
						// Remove will-change after transform completes to save memory
						clearTimeout(this.willChangeTimeout);
						this.willChangeTimeout = setTimeout(() => {
							target.style.willChange = 'auto';
							this.isTransforming = false;
						}, 200);
						
						this.rafId = null;
					});
				}



				renderMap() {
				// Show loading state
				const mapView = document.getElementById('map-view');
			console.log('[DEBUG] renderMap called, adding loading state');
			mapView.classList.add('loading');

			// Clear existing SVG content first
			this.svg.innerHTML = '';
			this.svg.classList.remove('ready');
			
			try {
				// Render custom map if available
				console.log('[DEBUG] Checking for custom map:', store.data.mapSvg, store.data.mapType);
				if (store.data.mapSvg && store.data.mapType === 'raster') {
					console.log('[DEBUG] Loading raster map');
					// Handle raster images (JPG, PNG, etc.)
					const width = store.data.mapWidth || 1000;
					const height = store.data.mapHeight || 600;
					
					// Update viewBox and SVG size
					this.svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
					this.svg.setAttribute('preserveAspectRatio', 'xMidYMid slice');
					
					// Create main group for all content
					const mainGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
					mainGroup.setAttribute('id', 'main-group');
					
					// Add image as background
					const image = document.createElementNS('http://www.w3.org/2000/svg', 'image');
					image.setAttribute('href', store.data.mapSvg);
					image.setAttribute('x', '0');
					image.setAttribute('y', '0');
					image.setAttribute('width', width);
					image.setAttribute('height', height);
					image.setAttribute('preserveAspectRatio', 'none');
					
					mainGroup.appendChild(image);
					
					// Create and add locations layer on top
					const locationsLayer = document.createElementNS('http://www.w3.org/2000/svg', 'g');
					locationsLayer.setAttribute('id', 'locations-layer');
					mainGroup.appendChild(locationsLayer);
					
					// Add main group to SVG
					this.svg.appendChild(mainGroup);
					this.mainGroup = mainGroup;
					this.locationsLayer = locationsLayer;
					
					// Wait for image to load before showing
					let imageLoaded = false;
					image.addEventListener('load', () => {
						imageLoaded = true;
						console.log('[DEBUG] Raster image loaded');
						mapView.classList.remove('loading');
						this.svg.classList.add('ready');
						this.render(); // Render locations after image is loaded and visible
					}, { once: true });
					
					// Fallback: remove loading state after VERY short timeout
					setTimeout(() => {
						if (!imageLoaded) {
							console.warn('[WARN] Map image load timeout after 500ms');
							mapView.classList.remove('loading');
							this.svg.classList.add('ready');
							this.render();
						}
					}, 500);
				} else {
					console.log('[DEBUG] Using grid fallback map');
					// Default map with grid (fallback)
					this.svg.setAttribute('viewBox', '0 0 1000 600');
					
					// Create defs with grid pattern
					const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
					const pattern = document.createElementNS('http://www.w3.org/2000/svg', 'pattern');
					pattern.setAttribute('id', 'grid');
					pattern.setAttribute('width', '50');
					pattern.setAttribute('height', '50');
					pattern.setAttribute('patternUnits', 'userSpaceOnUse');
					
					const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
					path.setAttribute('d', 'M 50 0 L 0 0 0 50');
					path.setAttribute('fill', 'none');
					path.setAttribute('stroke', 'rgba(100,100,100,0.1)');
					path.setAttribute('stroke-width', '1');
					pattern.appendChild(path);
					defs.appendChild(pattern);
					
					const mainGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
					mainGroup.setAttribute('id', 'main-group');
					
					// Add grid background
					const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
					rect.setAttribute('width', '1000');
					rect.setAttribute('height', '600');
					rect.setAttribute('fill', 'url(#grid)');
					mainGroup.appendChild(rect);
					
					// Create and add locations layer on top
					const locationsLayer = document.createElementNS('http://www.w3.org/2000/svg', 'g');
					locationsLayer.setAttribute('id', 'locations-layer');
					mainGroup.appendChild(locationsLayer);
					
					this.svg.appendChild(defs);
					this.svg.appendChild(mainGroup);
					this.mainGroup = mainGroup;
					this.locationsLayer = locationsLayer;

					// Show the grid (no image to wait for)
					console.log('[DEBUG] Grid created, removing loading state');
					}
				} catch (err) {
					console.error('[ERROR] renderMap failed:', err);
					mapView.classList.remove('loading');
					this.svg.classList.add('ready');
				}
			}

		render() {
			const locations = store.getAll('locations');
			const centerX = 5774;
			const centerY = 3862;
			const rangeX = 11548 * 0.4;
			const rangeY = 7724 * 0.4;

			locations.forEach((location) => {
				const x = location.x || (centerX - rangeX/2 + Math.random() * rangeX);
				const y = location.y || (centerY - rangeY/2 + Math.random() * rangeY);
				
				const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
				g.classList.add('map-location');
				
				const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
				circle.setAttribute('cx', x);
				circle.setAttribute('cy', y);
				circle.setAttribute('r', 80); // Increased from 8 to 80 for 11548Ã—7724 map
				
				const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
				text.setAttribute('x', x);
				text.setAttribute('y', y - 120); // Increased offset from -15 to -120
				text.setAttribute('font-size', '120'); // Added explicit font size
				text.textContent = location.name;
				
				g.appendChild(circle);
				g.appendChild(text);
				
				g.addEventListener('click', () => {
					showLocationDetails(location.id);
				});
				
				this.locationsLayer.appendChild(g);
			});
		}
	}

// Detail Panel Controller
function showLocationDetails(locationId) {
	const location = store.get('locations', locationId);
	const panel = document.getElementById('detail-panel');
	const title = document.getElementById('detail-title');
	const content = document.getElementById('detail-content');

	// Hide equipment panel if it's open
	hideEquipmentPanel();

	title.textContent = location.name;

	// Get related NPCs and items
	const relatedNPCs = store.getAll('npcs').filter(npc => npc.locationId === locationId);
	const relatedItems = store.getAll('items').filter(item => item.locationId === locationId);
	
	let html = '<div class="detail-section">';
	html += '<h3>Description</h3>';
	html += '<p>' + (location.description || 'No description available.') + '</p>';
	html += '</div>';
	
	if (location.history) {
		html += '<div class="detail-section">';
		html += '<h3>History</h3>';
		html += '<p>' + location.history + '</p>';
		html += '</div>';
	}
	
	if (relatedNPCs.length > 0) {
		html += '<div class="detail-section">';
		html += '<h3>NPCs</h3>';
		html += '<ul class="npc-list">';
		relatedNPCs.forEach(npc => {
			html += '<li class="npc-item" data-item-id="' + npc.id + '" data-item-type="npcs" style="cursor: pointer;">';
			html += '<div class="npc-name" style="color: var(--link); text-decoration: underline;">' + npc.name + '</div>';
			html += '<div class="npc-role">' + (npc.role || 'Unknown role') + '</div>';
			html += '</li>';
		});
		html += '</ul>';
		html += '</div>';
	}
	
	if (relatedItems.length > 0) {
		html += '<div class="detail-section">';
		html += '<h3>Items</h3>';
		html += '<ul class="item-list">';
		relatedItems.forEach(item => {
			html += '<li class="item-item" data-item-id="' + item.id + '" data-item-type="items" style="cursor: pointer;">';
			html += '<div class="item-name" style="color: var(--link); text-decoration: underline;">' + item.name + '</div>';
			html += '<div class="item-type">' + (item.type || 'Unknown type') + '</div>';
			html += '</li>';
		});
		html += '</ul>';
		html += '</div>';
	}
	
	content.innerHTML = html;
	panel.classList.remove('hidden');
	
	// Use visualViewport API to properly display panel at normal scale
	function updateDetailPanelZoom() {
		if (window.visualViewport && window.innerWidth <= 768) {
			const scale = window.visualViewport.scale;
			const vvWidth = window.visualViewport.width;
			const vvHeight = window.visualViewport.height;
			const offsetX = window.visualViewport.offsetLeft;
			const offsetY = window.visualViewport.offsetTop;
			
			if (scale > 1) {
				// Calculate inverse scale
				const inverseScale = 1 / scale;
				
				// The panel needs to be scaled down, so we make it larger before scaling
				// We want the final result to be exactly vvWidth x vvHeight
				const panelWidth = vvWidth * scale;
				const panelHeight = vvHeight * scale;
				
				// Set the panel to fill the visual viewport at normal scale
				panel.style.transform = `scale(${inverseScale})`;
				panel.style.transformOrigin = 'top left';
				panel.style.boxSizing = 'border-box';
				
				// Set dimensions exactly
				panel.style.width = `${panelWidth}px`;
				panel.style.height = `${panelHeight}px`;
				panel.style.minWidth = `${panelWidth}px`;
				panel.style.minHeight = `${panelHeight}px`;
				panel.style.maxWidth = `${panelWidth}px`;
				panel.style.maxHeight = `${panelHeight}px`;
				
				// Position at the visual viewport location
				panel.style.left = `${offsetX}px`;
				panel.style.top = `${offsetY}px`;
				panel.style.right = 'auto';
				
				// Ensure no overflow
				panel.style.overflow = 'hidden';
				panel.style.overflowY = 'auto';
			} else {
				// Reset to normal when not zoomed
				panel.style.transform = 'none';
				panel.style.transformOrigin = 'top right';
				panel.style.width = '100%';
				panel.style.height = '100vh';
				panel.style.left = 'auto';
				panel.style.right = '0';
				panel.style.top = '0';
				panel.style.overflow = 'hidden';
				panel.style.overflowY = 'auto';
			}
		}
	}
	
	updateDetailPanelZoom();
	
	// Listen for viewport changes
	if (window.visualViewport) {
		const updateHandler = () => updateDetailPanelZoom();
		window.visualViewport.addEventListener('resize', updateHandler);
		window.visualViewport.addEventListener('scroll', updateHandler);
		
		// Clean up listeners when panel closes
		const originalClose = panel.querySelector('#btn-close-detail');
		if (originalClose) {
			const oldHandler = originalClose.onclick;
			originalClose.onclick = function(e) {
				window.visualViewport.removeEventListener('resize', updateHandler);
				window.visualViewport.removeEventListener('scroll', updateHandler);
				if (oldHandler) oldHandler.call(this, e);
				else hideDetailPanel();
			};
		}
	}
}

function hideDetailPanel() {
	document.getElementById('detail-panel').classList.add('hidden');
	// Allow zoom again when closing detail panel
	const viewportMeta = document.querySelector('meta[name="viewport"]');
	if (viewportMeta) {
		viewportMeta.setAttribute('content', 'width=device-width, initial-scale=1, maximum-scale=10');
	}
}

function hideEquipmentPanel() {
	const panel = document.getElementById('equipment-panel');
	panel.classList.add('hidden');
	panel.classList.remove('active');
}

async function showEquipmentPanel() {
	const panel = document.getElementById('equipment-panel');
	const resultsDiv = document.getElementById('equipment-results');
	const countBadge = document.getElementById('badge-equipment-count');
	
	// Hide detail panel first
	hideDetailPanel();
	
	panel.classList.remove('hidden');
	panel.classList.add('active');
	
	// Load equipment list if not already loaded
	try {
		const data = await store.getEquipmentList();
		const equipmentList = data.results || data;
		
		// Update the badge count
		if (countBadge) {
			countBadge.textContent = equipmentList.length || 0;
		}
	
	// Also update the categories screen badge
	const categoriesBadge = document.getElementById('badge-equipment');
	if (categoriesBadge) {
		categoriesBadge.textContent = equipmentList.length || 0;
	}
	
	displayEquipmentList(equipmentList);
} catch (error) {
	resultsDiv.innerHTML = '<div class="equipment-loading">Error loading equipment data. Please try again.</div>';
	if (countBadge) {
		countBadge.textContent = '0';
	}
	if (categoriesBadge) {
		categoriesBadge.textContent = '0';
	}
}
}

function displayEquipmentList(equipment) {
const resultsDiv = document.getElementById('equipment-results');

if (!equipment || equipment.length === 0) {
	resultsDiv.innerHTML = '<div class="equipment-loading">No equipment found.</div>';
	return;
}

// Store the FULL equipment list for search (only set if not already set, to preserve master list)
if (!window.fullEquipmentList) {
	window.fullEquipmentList = equipment;
}
	
	const html = equipment.map(item => {
		const name = item.name || item.index || 'Unknown';
		const index = item.index || '';
		return `<div class="equipment-item" data-index="${index}">
			<div class="equipment-item-name">${name}</div>
			<div class="equipment-item-type">${item.equipment_category?.name || 'Equipment'}</div>
		</div>`;
	}).join('');
	
	resultsDiv.innerHTML = html;
	
	// Add click handlers to show details
	resultsDiv.querySelectorAll('.equipment-item').forEach(item => {
		item.addEventListener('click', async () => {
			const index = item.dataset.index;
			const selectedEquipment = window.fullEquipmentList.find(e => e.index === index);
			console.log('[DEBUG] Equipment item clicked:', { index, selectedEquipment });
			if (selectedEquipment && selectedEquipment.url) {
				await showEquipmentDetails(selectedEquipment);
			} else {
				console.error('[ERROR] Equipment not found or missing URL:', { index, selectedEquipment });
			}
		});
	});
}

async function showEquipmentDetails(equipment) {
	try {
		console.log('[DEBUG] Loading details for equipment:', equipment);
		const details = await store.getEquipmentDetail(equipment.url);
		const panel = document.getElementById('detail-panel');
		const title = document.getElementById('detail-title');
		const content = document.getElementById('detail-content');
		
		// Hide equipment panel, show detail panel with equipment info
		hideEquipmentPanel();
		
		title.textContent = details.name || equipment.name;
		
		let html = '<div class="detail-section">';
		html += '<h3>Equipment Details</h3>';
		
		// Equipment Categories
		if (details.equipment_category?.name) {
			html += '<p><strong>Category:</strong> ' + details.equipment_category.name + '</p>';
		}
		
		if (details.gear_category?.name) {
			html += '<p><strong>Gear Type:</strong> ' + details.gear_category.name + '</p>';
		}
		
		// Weapon-specific fields
		if (details.weapon_category) {
			html += '<p><strong>Weapon Type:</strong> ' + details.weapon_category + '</p>';
		}
		
		if (details.weapon_range) {
			html += '<p><strong>Range:</strong> ' + details.weapon_range + '</p>';
		}
		
		if (details.category_range) {
			html += '<p><strong>Classification:</strong> ' + details.category_range + '</p>';
		}
		
		// Damage
		if (details.damage) {
			let damageText = details.damage.damage_dice || 'unknown';
			if (details.damage.damage_type?.name) {
				damageText += ' ' + details.damage.damage_type.name;
			}
			html += '<p><strong>Damage:</strong> ' + damageText + '</p>';
		}
		
		// Range information
		if (details.range?.normal) {
			html += '<p><strong>Range:</strong> ' + details.range.normal + ' ft</p>';
		}
		
		if (details.range?.long) {
			html += '<p><strong>Long Range:</strong> ' + details.range.long + ' ft</p>';
		}
		
		// Weight
		if (details.weight !== undefined && details.weight !== null) {
			html += '<p><strong>Weight:</strong> ' + details.weight + ' lb</p>';
		}
		
		// Cost
		if (details.cost?.quantity !== undefined) {
			const unit = details.cost.unit || 'gp';
			html += '<p><strong>Cost:</strong> ' + details.cost.quantity + ' ' + unit + '</p>';
		}
		
		// Description
		if (details.desc && Array.isArray(details.desc) && details.desc.length > 0) {
			html += '<p>' + details.desc.join('</p><p>') + '</p>';
		}
		
		// Special properties
		if (details.special && Array.isArray(details.special) && details.special.length > 0) {
			html += '<p><strong>Special:</strong> ' + details.special.join(', ') + '</p>';
		}
		
		// Weapon properties (Heavy, Two-Handed, etc)
		if (details.properties && Array.isArray(details.properties) && details.properties.length > 0) {
			const propNames = details.properties.map(p => p.name || p.index).join(', ');
			html += '<p><strong>Properties:</strong> ' + propNames + '</p>';
		}
		
		// Contents (for containers)
		if (details.contents && Array.isArray(details.contents) && details.contents.length > 0) {
			html += '<p><strong>Contains:</strong></p><ul>';
			details.contents.forEach(item => {
				html += '<li>' + (item.item?.name || item.name || 'Unknown') + '</li>';
			});
			html += '</ul>';
		}
		
		html += '</div>';
		html += '<div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border);"><button class="btn btn-back-equipment" style="width: 100%;">Back to Equipment</button></div>';
		
		content.innerHTML = html;
		panel.classList.remove('hidden');
		
	} catch (error) {
		console.error('[ERROR] Failed to load equipment details:', error.message, error);
		const panel = document.getElementById('detail-panel');
		const title = document.getElementById('detail-title');
		const content = document.getElementById('detail-content');
		
		title.textContent = equipment?.name || 'Equipment';
		content.innerHTML = '<div class="empty-state"><p>Error loading equipment details: ' + error.message + '</p><p style="font-size: 0.9em; color: var(--muted-fg);">Check browser console for more details.</p><button class="btn btn-back-equipment" style="width: 100%; margin-top: 20px;">Back to Equipment</button></div>';
		panel.classList.remove('hidden');
	}
}

	function showAllCategories() {
		const panel = document.getElementById('detail-panel');
		const title = document.getElementById('detail-title');
		const content = document.getElementById('detail-content');

		title.textContent = 'All Items';

	// Map category names to their display names (matching the sidebar)
	const categoryNames = {
		'locations': 'Locations',
		'npcs': 'NPCs',
		'items': 'Items',
		'events': 'Events'
	};

	const categories = ['locations', 'npcs', 'items', 'events'];
	let allHTML = '';

	categories.forEach(category => {
		const items = store.getAll(category);
		if (items.length === 0) return;

		const categoryName = categoryNames[category] || category.charAt(0).toUpperCase() + category.slice(1);
		allHTML += '<div style="margin-bottom: 24px;">';
		allHTML += '<h3 style="margin: 0 0 12px; font-size: 1.1rem; color: var(--link); border-bottom: 2px solid var(--border); padding-bottom: 8px;">' + categoryName + ' (' + items.length + ')</h3>';
		allHTML += '<div style="display: flex; flex-direction: column; gap: 8px;">';

		items.forEach(item => {
			let html = '<div class="item-list-entry" data-category="' + category + '" data-id="' + item.id + '" style="padding: 12px; border: 1px solid var(--border); border-radius: 4px; cursor: pointer; transition: all 0.2s; background: var(--bg);">';
			html += '<div style="font-weight: 600; color: var(--link);">' + item.name + '</div>';
			if (item.role) html += '<div style="font-size: 0.9em; color: var(--muted-fg);">' + item.role + '</div>';
			if (item.type) html += '<div style="font-size: 0.9em; color: var(--muted-fg);">' + item.type + '</div>';
			if (item.date) html += '<div style="font-size: 0.9em; color: var(--muted-fg);">' + item.date + '</div>';
			html += '</div>';
			allHTML += html;
		});

		allHTML += '</div></div>';
	});

	if (allHTML === '') {
		content.innerHTML = '<div class="empty-state"><p>No items yet. Click + Add New to create one.</p></div>';
	} else {
		content.innerHTML = '<div class="item-list-container">' + allHTML + '</div>';

		// Add event listeners to all items
		content.querySelectorAll('.item-list-entry').forEach(entry => {
			entry.addEventListener('mouseover', function() {
			this.style.backgroundColor = 'var(--hover)';
			this.style.borderColor = 'var(--link)';
		});
		entry.addEventListener('mouseout', function() {
			this.style.backgroundColor = 'var(--bg)';
			this.style.borderColor = 'var(--border)';
		});

		entry.addEventListener('click', () => {
			const itemId = parseInt(entry.dataset.id);
			const category = entry.dataset.category;
			showItemDetails(category, itemId);
		});
	});
}

panel.classList.remove('hidden');
}

function showCategoryList(category) {
const panel = document.getElementById('detail-panel');
const title = document.getElementById('detail-title');
const content = document.getElementById('detail-content');

// Map category names to their display names (matching the sidebar)
const categoryNames = {
	'locations': 'Locations',
	'npcs': 'NPCs',
	'items': 'Items',
	'events': 'Events'
};

let categoryName = categoryNames[category] || category.charAt(0).toUpperCase() + category.slice(1);
let items = store.getAll(category);

title.textContent = categoryName;

if (items.length === 0) {
	content.innerHTML = '<div class="empty-state"><p>No ' + category + ' yet. Click + Add New to create one.</p></div>';
	panel.classList.remove('hidden');
	return;
}

const itemsHTML = items.map(item => {
	let html = '<div class="item-list-entry" data-id="' + item.id + '" style="padding: 12px; border: 1px solid var(--border); border-radius: 4px; cursor: pointer; margin-bottom: 8px; transition: all 0.2s;">';
	html += '<div style="font-weight: 600; color: var(--link);">' + item.name + '</div>';
	if (item.role) html += '<div style="font-size: 0.9em; color: var(--muted-fg);">' + item.role + '</div>';
	if (item.type) html += '<div style="font-size: 0.9em; color: var(--muted-fg);">' + item.type + '</div>';
	if (item.date) html += '<div style="font-size: 0.9em; color: var(--muted-fg);">' + item.date + '</div>';
	html += '</div>';
	return html;
}).join('');

content.innerHTML = '<div class="item-list-container">' + itemsHTML + '</div>';
content.querySelectorAll('.item-list-entry').forEach(entry => {
	entry.addEventListener('mouseover', function() {
		this.style.backgroundColor = 'var(--hover)';
		this.style.borderColor = 'var(--link)';
	});
	entry.addEventListener('mouseout', function() {
		this.style.backgroundColor = 'transparent';
		this.style.borderColor = 'var(--border)';
	});
	
	entry.addEventListener('click', () => {
		const itemId = parseInt(entry.dataset.id);
		showItemDetails(category, itemId);
	});
});

panel.classList.remove('hidden');
}

function showItemDetails(category, itemId) {
	const panel = document.getElementById('detail-panel');
	const title = document.getElementById('detail-title');
	const content = document.getElementById('detail-content');
	const item = store.get(category, itemId);
	
	// Hide equipment panel if it's open
	hideEquipmentPanel();
	
	title.textContent = item.name;

			let detailsHTML = '<div class="detail-section">';

			if (category === 'locations') {
				if (item.description) detailsHTML += '<div style="margin-bottom: 12px;"><h3>Description</h3><p>' + item.description + '</p></div>';
				if (item.history) detailsHTML += '<div style="margin-bottom: 12px;"><h3>History</h3><p>' + item.history + '</p></div>';

				const relatedNPCs = store.getAll('npcs').filter(npc => npc.locationId === itemId);
				if (relatedNPCs.length > 0) {
					detailsHTML += '<div style="margin-bottom: 12px;"><h3>NPCs Here</h3><ul>';
					relatedNPCs.forEach(npc => {
						detailsHTML += '<li>' + npc.name + (npc.role ? ' - ' + npc.role : '') + '</li>';
					});
					detailsHTML += '</ul></div>';
				}

				const relatedItems = store.getAll('items').filter(itm => itm.locationId === itemId);
				if (relatedItems.length > 0) {
					detailsHTML += '<div style="margin-bottom: 12px;"><h3>Items Here</h3><ul>';
					relatedItems.forEach(itm => {
						detailsHTML += '<li>' + itm.name + (itm.type ? ' (' + itm.type + ')' : '') + '</li>';
					});
					detailsHTML += '</ul></div>';
				}
			} else if (category === 'npcs') {
				if (item.role) detailsHTML += '<div style="margin-bottom: 12px;"><h3>Role/Title</h3><p>' + item.role + '</p></div>';
				if (item.description) detailsHTML += '<div style="margin-bottom: 12px;"><h3>Description</h3><p>' + item.description + '</p></div>';
				if (item.locationId) {
					const location = store.get('locations', item.locationId);
					if (location) detailsHTML += '<div style="margin-bottom: 12px;"><h3>Location</h3><p>' + location.name + '</p></div>';
				}
			} else if (category === 'items') {
				if (item.type) detailsHTML += '<div style="margin-bottom: 12px;"><h3>Type</h3><p>' + item.type + '</p></div>';
				if (item.description) detailsHTML += '<div style="margin-bottom: 12px;"><h3>Description</h3><p>' + item.description + '</p></div>';
				if (item.locationId) {
					const location = store.get('locations', item.locationId);
					if (location) detailsHTML += '<div style="margin-bottom: 12px;"><h3>Found At</h3><p>' + location.name + '</p></div>';
				}
			} else if (category === 'events') {
				if (item.date) detailsHTML += '<div style="margin-bottom: 12px;"><h3>Date/Time</h3><p>' + item.date + '</p></div>';
				if (item.description) detailsHTML += '<div style="margin-bottom: 12px;"><h3>Description</h3><p>' + item.description + '</p></div>';
				if (item.locationId) {
					const location = store.get('locations', item.locationId);
					if (location) detailsHTML += '<div style="margin-bottom: 12px;"><h3>Location</h3><p>' + location.name + '</p></div>';
				}
			}

			if (item.createdAt) {
				detailsHTML += '<div style="font-size: 0.85em; color: var(--muted-fg); margin-top: 16px; padding-top: 8px; border-top: 1px solid var(--border);\">Added ' + new Date(item.createdAt).toLocaleDateString() + '</div>';
			}

			detailsHTML += '</div>';
		content.innerHTML = detailsHTML;
		panel.classList.remove('hidden');
	}

	// Modal Controller
	const modal = document.getElementById('modal-add');
	const form = document.getElementById('form-add');
	const typeSelect = document.getElementById('add-type');
	const formFields = document.getElementById('form-fields');

	function getFormTemplate(type) {
		if (type === 'location') {
			return '<div class="form-group">' +
				'<label for="name">Name</label>' +
				'<input type="text" id="name" name="name" required>' +
				'</div>' +
				'<div class="form-group">' +
				'<label for="description">Description</label>' +
					'<textarea id="description" name="description"></textarea>' +
					'</div>' +
					'<div class="form-group">' +
					'<label for="history">History</label>' +
					'<textarea id="history" name="history"></textarea>' +
					'</div>' +
					'<div class="form-group">' +
					'<label for="x">Map X Position (optional)</label>' +
					'<input type="number" id="x" name="x" min="0" max="1000">' +
					'</div>' +
					'<div class="form-group">' +
					'<label for="y">Map Y Position (optional)</label>' +
					'<input type="number" id="y" name="y" min="0" max="600">' +
					'</div>';
			} else if (type === 'npc') {
				const locations = store.getAll('locations');
				let locationOptions = '<option value="">None</option>';
				locations.forEach(loc => {
					locationOptions += '<option value="' + loc.id + '">' + loc.name + '</option>';
				});
				return '<div class="form-group">' +
					'<label for="name">Name *</label>' +
					'<input type="text" id="name" name="name" required>' +
					'</div>' +
					'<div class="form-group">' +
					'<label for="role">Role/Title</label>' +
					'<input type="text" id="role" name="role">' +
					'</div>' +
					'<div class="form-group">' +
					'<label for="description">Description</label>' +
					'<textarea id="description" name="description"></textarea>' +
					'</div>' +
					'<div class="form-group">' +
					'<label for="locationId">Associated Location</label>' +
					'<select id="locationId" name="locationId">' +
					locationOptions +
					'</select>' +
					'</div>';
			} else if (type === 'item') {
				const locations = store.getAll('locations');
				let locationOptions = '<option value="">Unknown</option>';
				locations.forEach(loc => {
					locationOptions += '<option value="' + loc.id + '">' + loc.name + '</option>';
				});
				return '<div class="form-group">' +
					'<label for="name">Name *</label>' +
					'<input type="text" id="name" name="name" required>' +
					'</div>' +
					'<div class="form-group">' +
					'<label for="type">Type</label>' +
					'<input type="text" id="type" name="type" placeholder="e.g., Weapon, Artifact, Consumable">' +
					'</div>' +
					'<div class="form-group">' +
					'<label for="description">Description</label>' +
					'<textarea id="description" name="description"></textarea>' +
					'</div>' +
					'<div class="form-group">' +
					'<label for="locationId">Found At</label>' +
					'<select id="locationId" name="locationId">' +
					locationOptions +
					'</select>' +
					'</div>';
			} else if (type === 'event') {
				const locations = store.getAll('locations');
				let locationOptions = '<option value="">Unknown</option>';
				locations.forEach(loc => {
					locationOptions += '<option value="' + loc.id + '">' + loc.name + '</option>';
				});
				return '<div class="form-group">' +
					'<label for="name">Event Name *</label>' +
					'<input type="text" id="name" name="name" required>' +
					'</div>' +
					'<div class="form-group">' +
					'<label for="date">Date/Time</label>' +
					'<input type="text" id="date" name="date" placeholder="e.g., Day 15 of Midsummer">' +
					'</div>' +
					'<div class="form-group">' +
					'<label for="description">Description</label>' +
					'<textarea id="description" name="description"></textarea>' +
					'</div>' +
					'<div class="form-group">' +
					'<label for="locationId">Location</label>' +
					'<select id="locationId" name="locationId">' +
					locationOptions +
					'</select>' +
					'</div>';
			}
			return '';
		}

		typeSelect.addEventListener('change', (e) => {
			const type = e.target.value;
			formFields.innerHTML = getFormTemplate(type);
	});

	document.getElementById('btn-add-new').addEventListener('click', () => {
		modal.classList.add('active');
	});

	document.getElementById('btn-close-modal').addEventListener('click', () => {
		modal.classList.remove('active');
		form.reset();
		formFields.innerHTML = '';
	});

	document.getElementById('btn-cancel').addEventListener('click', () => {
		modal.classList.remove('active');
		form.reset();
		formFields.innerHTML = '';
	});

	form.addEventListener('submit', (e) => {
		e.preventDefault();
		
		const formData = new FormData(form);
		const data = Object.fromEntries(formData);
		const type = data.type + 's'; // Convert to plural for storage
		
		delete data.type;
		
		// Convert numeric fields
		if (data.x) data.x = parseFloat(data.x);
		if (data.y) data.y = parseFloat(data.y);
		
		store.add(type, data);
		
		modal.classList.remove('active');
		form.reset();
		formFields.innerHTML = '';
		
		// Refresh map if location was added
		if (type === 'locations') {
			mapController.render();
		}
	});

	// Close detail panel
	document.getElementById('btn-close-detail').addEventListener('click', hideDetailPanel);

	// Event delegation for dynamically created elements in detail panel
	document.getElementById('detail-panel').addEventListener('click', (e) => {
		// Handle NPC and item clicks
		const npcItem = e.target.closest('.npc-item');
		const itemItem = e.target.closest('.item-item');
		const backButton = e.target.closest('.btn-back-equipment');
		
		if (npcItem) {
			const id = npcItem.dataset.itemId;
			const type = npcItem.dataset.itemType;
			if (id && type) {
				showItemDetails(type, parseInt(id));
			}
		} else if (itemItem) {
			const id = itemItem.dataset.itemId;
			const type = itemItem.dataset.itemType;
			if (id && type) {
				showItemDetails(type, parseInt(id));
			}
		} else if (backButton) {
			showEquipmentPanel();
		}
	});

	// Close equipment panel
	document.getElementById('btn-close-equipment').addEventListener('click', hideEquipmentPanel);

	// Equipment search
	const equipmentSearchInput = document.getElementById('equipment-search');
	
	equipmentSearchInput.addEventListener('input', (e) => {
		const query = e.target.value.toLowerCase().trim();
		const equipment = window.fullEquipmentList || [];
		
		if (!query) {
			// Show all equipment when search is cleared
			displayEquipmentList(equipment);
			return;
		}
		
		// Filter from the full list
		const filtered = equipment.filter(item => {
			const name = (item.name || item.index || '').toLowerCase();
			const category = (item.equipment_category?.name || '').toLowerCase();
			return name.includes(query) || category.includes(query);
		});
		
		displayEquipmentList(filtered);
	});

	// Category filter
	document.querySelectorAll('.category-item').forEach(item => {
		item.addEventListener('click', () => {
			document.querySelectorAll('.category-item').forEach(i => i.classList.remove('active'));
			item.classList.add('active');
			
			const category = item.dataset.category;
			if (category === 'all') {
				showAllCategories();
				hideEquipmentPanel();
			} else if (category === 'equipment') {
				hideDetailPanel();
				showEquipmentPanel();
			} else {
				hideEquipmentPanel();
				showCategoryList(category);
			}
		});
	});

// Search category filter
const searchCategoryFilter = document.getElementById('search-category-filter');

if (searchCategoryFilter) {
	searchCategoryFilter.addEventListener('input', (e) => {
		const query = e.target.value.toLowerCase().trim();
		document.querySelectorAll('.search-category-item').forEach(item => {
			const text = item.textContent.toLowerCase();
			item.style.display = text.includes(query) ? 'flex' : 'none';
		});
	});
}

// Search category items
document.querySelectorAll('.search-category-item').forEach(item => {
	item.addEventListener('click', () => {
		const searchType = item.dataset.searchType;
		// Navigate to search page
		showPage('search');
		// Set the search type dropdown
		document.getElementById('search-type').value = searchType;
		// Clear and focus search input
		const searchInput = document.getElementById('search-query');
		searchInput.value = '';
		searchInput.focus();
		// Close sidebar on mobile
		closeSidebar();
	});
});

// Initialize
const mapController = new MapController();
console.log('[DEBUG] mapController created');

// Export functionality
document.getElementById('btn-export').addEventListener('click', () => {
	store.exportData();
});

// Import functionality
document.getElementById('btn-import').addEventListener('change', async (e) => {
	const file = e.target.files[0];
	if (file) {
		const success = await store.importData(file);
		if (success) {
			mapController.render();
			alert('Data imported successfully!');
		}
		// Reset input so same file can be imported again
		e.target.value = '';
	}
});

	// Upload Map functionality
	document.getElementById('btn-upload-map').addEventListener('change', async (e) => {
		const file = e.target.files[0];
		if (file) {
			const success = await store.uploadMap(file);
			if (success) {
				mapController.renderMap();
				alert('Map uploaded successfully! Don\'t forget to export your data to save the map.');
			}
			// Reset input so same file can be uploaded again
			e.target.value = '';
		}
	});

	// Mobile menu toggle
	const sidebar = document.getElementById('sidebar');
	const menuBtn = document.getElementById('btn-menu');
	const menuCloseBtn = document.getElementById('btn-menu-close');
	const overlay = document.getElementById('mobile-overlay');
	const closeSidebarBtn = document.getElementById('btn-close-sidebar');

	function closeSidebar() {
		sidebar.classList.remove('active');
		sidebar.classList.add('hidden');
		overlay.classList.remove('active');
		menuCloseBtn.classList.add('hidden');
		menuBtn.classList.remove('hidden');
	}

	menuBtn.addEventListener('click', () => {
		sidebar.classList.toggle('active');
		sidebar.classList.remove('hidden');
		overlay.classList.remove('active');
		menuCloseBtn.classList.toggle('hidden');
		menuBtn.classList.add('hidden');
	});

	overlay.addEventListener('click', closeSidebar);

	// Close button for sidebar
	if (closeSidebarBtn) {
		closeSidebarBtn.addEventListener('click', closeSidebar);
	}

	// Close button in header
	if (menuCloseBtn) {
		menuCloseBtn.addEventListener('click', closeSidebar);
	}

	// Close menu when clicking on a category (mobile only)
	if (window.innerWidth <= 768) {
		document.querySelectorAll('.category-item').forEach(item => {
			item.addEventListener('click', closeSidebar);
		});
	}

	// ============================================
	// Page Navigation
	// ============================================
	
	let currentPage = 'map';
	const mapContainer = document.querySelector('.container');
	const pages = {
		map: mapContainer,
		home: document.getElementById('search-page'), // Reusing search as home-like
		search: document.getElementById('search-page'),
		inventory: document.getElementById('inventory-page')
	};

	function showPage(pageName) {
		// Hide all pages and show only the active one
		const searchPage = document.getElementById('search-page');
		const inventoryPage = document.getElementById('inventory-page');
		const mapContainer = document.getElementById('main-content');
		
		// For search page
		if (pageName === 'search') {
			searchPage.classList.add('active');
			searchPage.classList.remove('hidden');
			inventoryPage.classList.remove('active');
			inventoryPage.classList.add('hidden');
			mapContainer.classList.add('hidden');
		} 
		// For inventory page
		else if (pageName === 'inventory') {
			inventoryPage.classList.add('active');
			inventoryPage.classList.remove('hidden');
			searchPage.classList.remove('active');
			searchPage.classList.add('hidden');
			mapContainer.classList.add('hidden');
		} 
		// For map
		else if (pageName === 'map') {
			searchPage.classList.remove('active');
			searchPage.classList.add('hidden');
			inventoryPage.classList.remove('active');
			inventoryPage.classList.add('hidden');
			mapContainer.classList.remove('hidden');
		}

		// Update nav buttons
		document.querySelectorAll('.nav-btn').forEach(btn => {
			const btnPage = btn.dataset.page === 'home' ? 'map' : btn.dataset.page;
			btn.classList.toggle('active', btnPage === pageName);
		});

		currentPage = pageName;
		closeSidebar();
	}

	// Handle navigation button clicks
	document.querySelectorAll('.nav-btn').forEach(btn => {
		btn.addEventListener('click', () => {
			const page = btn.dataset.page;
			if (page === 'home') {
				showPage('map');
			} else {
				showPage(page);
			}
		});
	});

	// Handle page title click to go to map
	document.getElementById('page-title').addEventListener('click', () => {
		showPage('map');
	});

	// Set initial active state for map (World Map)
	document.querySelector('[data-page="map"]').classList.add('active');

	// ============================================
	// Party Inventory Management
	// ============================================

	class InventoryManager {
		constructor() {
			this.storageKey = 'partyInventory';
			this.inventory = null;
			this.initEventListeners();
		}

		async init() {
			this.inventory = await this.loadInventory();
			this.renderInventory();
		}

async loadInventory() {
		const stored = localStorage.getItem(this.storageKey);
		if (stored) {
			return JSON.parse(stored);
		}
		// Load default inventory from JSON file
		try {
			const response = await fetch('inventory.json');
			if (response.ok) {
				return await response.json();
			}
		} catch (e) {
			console.warn('Could not load default inventory:', e);
			}
			return {
				platinum: 0,
				gold: 0,
				silver: 0,
				copper: 0,
				items: []
			};
		}

		saveInventory() {
			localStorage.setItem(this.storageKey, JSON.stringify(this.inventory));
			this.renderInventory();
		}

		initEventListeners() {
			// Currency inputs
			document.getElementById('currency-platinum').addEventListener('change', (e) => {
				if (this.inventory) {
					this.inventory.platinum = parseInt(e.target.value) || 0;
					this.saveInventory();
				}
			});
			document.getElementById('currency-gold').addEventListener('change', (e) => {
				if (this.inventory) {
					this.inventory.gold = parseInt(e.target.value) || 0;
					this.saveInventory();
				}
			});
			document.getElementById('currency-silver').addEventListener('change', (e) => {
				if (this.inventory) {
					this.inventory.silver = parseInt(e.target.value) || 0;
					this.saveInventory();
				}
			});
			document.getElementById('currency-copper').addEventListener('change', (e) => {
				if (this.inventory) {
					this.inventory.copper = parseInt(e.target.value) || 0;
					this.saveInventory();
				}
			});

			// Add item button
			document.getElementById('btn-add-item').addEventListener('click', () => {
				this.showAddItemModal();
			});

			// Close add item modal
			document.getElementById('btn-close-add-item-modal').addEventListener('click', () => {
				this.closeAddItemModal();
			});

			// Search in add item modal
			document.getElementById('add-item-search').addEventListener('input', (e) => {
				this.searchEquipmentForAdd(e.target.value);
			});

			// Load initial data
			this.renderInventory();
		}

		renderInventory() {
			if (!this.inventory) return;
			
			// Update currency displays
			document.getElementById('currency-platinum').value = this.inventory.platinum || 0;
			document.getElementById('currency-gold').value = this.inventory.gold;
			document.getElementById('currency-silver').value = this.inventory.silver;
			document.getElementById('currency-copper').value = this.inventory.copper;

			// Render items
			const itemsContainer = document.getElementById('inventory-items');
			if (this.inventory.items.length === 0) {
				itemsContainer.innerHTML = '<div class="empty-state">No items in inventory. Click "Add Item" to begin.</div>';
				return;
			}

		itemsContainer.innerHTML = this.inventory.items.map((item, index) => {
			let details = [];
			if (item.equipment_category?.name) {
				details.push(item.equipment_category.name);
			}
			if (item.cost?.quantity && item.cost?.unit) {
				details.push(item.cost.quantity + ' ' + item.cost.unit);
			}
			if (item.weight) {
				details.push(item.weight + ' lb.');
			}
			
			// Add damage info for weapons
			let damageInfo = '';
			if (item.damage) {
				let damageText = item.damage.damage_dice || 'unknown';
				if (item.damage.damage_type?.name) {
					damageText += ' ' + item.damage.damage_type.name;
				}
				damageInfo = `<p style="margin: 0 0 8px; color: var(--link); font-weight: 600;">âš”ï¸ ${damageText}</p>`;
			}
			
			const detailText = details.length > 0 ? details.join(' â€¢ ') : 'Equipment';
			
			return `
				<div class="inventory-item">
					<div class="inventory-item-info">
						<h4>${item.name}</h4>
						<p>${detailText}</p>
						${damageInfo}
					</div>
					<div class="inventory-item-controls">
						<div class="inventory-item-qty">
							<button class="inventory-qty-btn" data-index="${index}" data-action="decrease">âˆ’</button>
							<span class="inventory-qty-display">${item.quantity || 1}</span>
							<button class="inventory-qty-btn" data-index="${index}" data-action="increase">+</button>
						</div>
						<button class="btn-remove-item" data-index="${index}">Remove</button>
					</div>
				</div>
			`;
		}).join('');

			// Attach event listeners
			document.querySelectorAll('.inventory-qty-btn').forEach(btn => {
				btn.addEventListener('click', (e) => {
					const index = parseInt(e.target.dataset.index);
					const action = e.target.dataset.action;
					if (action === 'increase') {
						this.inventory.items[index].quantity++;
					} else if (action === 'decrease' && this.inventory.items[index].quantity > 1) {
						this.inventory.items[index].quantity--;
					}
					this.saveInventory();
				});
			});

			document.querySelectorAll('.btn-remove-item').forEach(btn => {
				btn.addEventListener('click', (e) => {
					const index = parseInt(e.target.dataset.index);
					this.inventory.items.splice(index, 1);
					this.saveInventory();
				});
			});
		}

		showAddItemModal() {
			const modal = document.getElementById('add-item-modal');
			modal.classList.add('active');
			document.body.style.overflow = 'hidden';
			document.getElementById('add-item-search').focus();
		}

		closeAddItemModal() {
			const modal = document.getElementById('add-item-modal');
			modal.classList.remove('active');
			document.body.style.overflow = '';
			document.getElementById('add-item-search').value = '';
			document.getElementById('add-item-results').innerHTML = '<div class="empty-state">Start typing to search equipment</div>';
		}

		async searchEquipmentForAdd(query) {
			const resultsContainer = document.getElementById('add-item-results');
			if (query.trim().length === 0) {
				resultsContainer.innerHTML = '<div class="empty-state">Start typing to search equipment</div>';
				return;
			}

			resultsContainer.innerHTML = '<div class="equipment-loading">Searching...</div>';

			try {
				const data = await store.getEquipmentList();
				const equipment = data.results || data;
				const filtered = equipment.filter(item => 
					item.name.toLowerCase().includes(query.toLowerCase())
				).slice(0, 20);

				if (filtered.length === 0) {
					resultsContainer.innerHTML = '<div class="empty-state">No equipment found</div>';
					return;
				}

// Fetch full details for each result to get damage, cost, weight, etc.
			const fullResults = await Promise.all(
				filtered.map(async (item) => {
					try {
						const details = await store.getEquipmentDetail(item.url);
						return details;
					} catch (e) {
						console.warn('Failed to fetch details for', item.name);
						return item;
					}
				})
			);

			resultsContainer.innerHTML = fullResults.map((item, idx) => `
				<div class="add-item-result">
					<div class="add-item-result-name">${item.name}</div>
					<div class="add-item-result-qty">
						<input type="number" class="add-item-qty-input" value="1" min="1" data-item-index="${idx}">
						<button class="btn-add-to-inventory" data-item-index="${idx}">Add</button>
						</div>
					</div>
				`).join('');

				// Attach event listeners
				document.querySelectorAll('.btn-add-to-inventory').forEach(btn => {
					btn.addEventListener('click', async (e) => {
						const itemIndex = parseInt(e.target.dataset.itemIndex);
						const qty = parseInt(e.target.parentElement.querySelector('.add-item-qty-input').value) || 1;
						await this.addItemToInventory(fullResults[itemIndex], qty);
						e.target.textContent = 'Added!';
						e.target.disabled = true;
						setTimeout(() => {
							this.closeAddItemModal();
						}, 500);
					});
				});
			} catch (error) {
				console.error('Error searching equipment:', error);
				resultsContainer.innerHTML = '<div class="empty-state">Error loading equipment data</div>';
			}
		}

		async addItemToInventory(item, quantity = 1) {
			// Check if item already exists
			const existingItem = this.inventory.items.find(i => i.index === item.index);
			if (existingItem) {
				existingItem.quantity += quantity;
			} else {
				this.inventory.items.push({
					...item,
					quantity: quantity
				});
			}
			this.saveInventory();
		}
	}

	// ============================================
	// Search Page Management
	// ============================================

	class SearchPageManager {
		constructor() {
			this.cache = {};
			this.initEventListeners();
		}

		initEventListeners() {
			const searchInput = document.getElementById('search-query');
			const typeSelect = document.getElementById('search-type');

			searchInput.addEventListener('input', () => this.performSearch());
			typeSelect.addEventListener('change', () => this.performSearch());
		}

		async loadData(type) {
			// Try to load from local data directory first
			if (this.cache[type]) {
				return this.cache[type];
			}

			try {
				const response = await fetch(`data/${type}.json`);
				if (response.ok) {
					const data = await response.json();
					this.cache[type] = data;
					return data;
				}
			} catch (e) {
				// Fall back to API
			}

			// Fall back to API
			const url = `https://www.dnd5eapi.co/api/2014/${type}`;
			try {
				const response = await fetch(url);
				if (response.ok) {
					const data = await response.json();
					this.cache[type] = data;
					return data;
				}
			} catch (e) {
				console.error(`Failed to load data for ${type}:`, e);
				throw e;
			}
		}

		async performSearch() {
			const query = document.getElementById('search-query').value.trim();
			const type = document.getElementById('search-type').value;
			const resultsContainer = document.getElementById('search-results');

			if (query.length === 0) {
				resultsContainer.innerHTML = '<div class="empty-state">Use the dropdown on the right to choose which part of the rules you would like to search.</div>';
				return;
			}

			if (query.length < 2) {
				resultsContainer.innerHTML = '<div class="empty-state">Keep typing...</div>';
				return;
			}

			resultsContainer.innerHTML = '<div class="equipment-loading">Searching...</div>';

		try {
			const data = await this.loadData(type);
			const items = data.results || data;

			// Search items
			let results = items.filter(item =>
				(item.name || item.index || '').toLowerCase().includes(query.toLowerCase())
			).slice(0, 10);

			if (results.length === 0) {
				resultsContainer.innerHTML = '<div class="empty-state">No results found</div>';
				return;
			}

			// Fetch full details for each result
			const fullResults = await Promise.all(
				results.map(async (item) => {
					try {
						// Try to get full details if available
						if (item.url) {
							const response = await fetch(`https://www.dnd5eapi.co${item.url}`);
							if (response.ok) {
								return await response.json();
							}
						}
						return item;
					} catch (e) {
						console.warn('Failed to fetch details for', item.name);
						return item;
					}
				})
			);

			// Render results based on type
			resultsContainer.innerHTML = fullResults.map(item => 
				this.renderSearchResult(item, type)
			).join('');
		} catch (error) {
			console.error('Error performing search:', error);
			resultsContainer.innerHTML = '<div class="empty-state">Error loading data. Please try again.</div>';
		}
	}

	renderSearchResult(item, type) {
		let html = `<div class="search-result-item"><h4>${item.name || item.index}</h4>`;

		switch(type) {
			case 'equipment':
				if (item.equipment_category) html += `<p><strong>Category:</strong> ${item.equipment_category.name}</p>`;
				if (item.weapon_category) html += `<p><strong>Weapon Type:</strong> ${item.weapon_category}</p>`;
				if (item.cost) html += `<p><strong>Cost:</strong> ${item.cost.quantity} ${item.cost.unit}</p>`;
				if (item.weight) html += `<p><strong>Weight:</strong> ${item.weight} lb.</p>`;
				if (item.damage) html += `<p><strong>Damage:</strong> ${item.damage.damage_dice} ${item.damage.damage_type.name}</p>`;
				if (item.weapon_range) html += `<p><strong>Range:</strong> ${item.weapon_range}</p>`;
				if (item.range?.normal) html += `<p><strong>Range:</strong> ${item.range.normal} ft${item.range.long ? ` / ${item.range.long} ft` : ''}</p>`;
				if (item.properties && Array.isArray(item.properties) && item.properties.length > 0) {
					const propNames = item.properties.map(p => p.name || p).join(', ');
					html += `<p><strong>Properties:</strong> ${propNames}</p>`;
				}
				if (item.rarity) html += `<p><strong>Rarity:</strong> ${item.rarity}</p>`;
				if (item.armor_class) {
					const acValue = typeof item.armor_class === 'object' ? item.armor_class.value : item.armor_class;
					html += `<p><strong>AC:</strong> ${acValue}</p>`;
				}
				break;

			case 'spells':
				if (item.level) {
					const levelName = item.level === 0 ? 'Cantrip' : `Level ${item.level}`;
					html += `<p><strong>Level:</strong> ${levelName}</p>`;
				}
				if (item.school) html += `<p><strong>School:</strong> ${item.school.name}</p>`;
				if (item.casting_time) html += `<p><strong>Casting Time:</strong> ${item.casting_time}</p>`;
				if (item.range) html += `<p><strong>Range:</strong> ${item.range}</p>`;
				if (item.duration) html += `<p><strong>Duration:</strong> ${item.duration}</p>`;
				if (item.concentration) html += `<p><strong>Concentration:</strong> Yes</p>`;
				if (item.ritual) html += `<p><strong>Ritual:</strong> Yes</p>`;
				if (item.components) html += `<p><strong>Components:</strong> ${item.components.join(', ')}</p>`;
				break;

			case 'monsters':
				if (item.challenge_rating !== undefined) html += `<p><strong>CR:</strong> ${item.challenge_rating}</p>`;
				if (item.size) html += `<p><strong>Size:</strong> ${item.size}</p>`;
				if (item.type) html += `<p><strong>Type:</strong> ${item.type}</p>`;
				if (item.alignment) html += `<p><strong>Alignment:</strong> ${item.alignment}</p>`;
				if (item.armor_class) {
					const acValue = typeof item.armor_class === 'object' ? item.armor_class.value : item.armor_class;
					html += `<p><strong>AC:</strong> ${acValue}</p>`;
				}
				if (item.hit_points) html += `<p><strong>HP:</strong> ${item.hit_points}</p>`;
				if (item.speed) html += `<p><strong>Speed:</strong> ${typeof item.speed === 'object' ? JSON.stringify(item.speed).replace(/[{}\"]/g, '') : item.speed}</p>`;
				break;

			case 'classes':
				if (item.hit_die) html += `<p><strong>Hit Die:</strong> d${item.hit_die}</p>`;
				if (item.saving_throws) html += `<p><strong>Saving Throws:</strong> ${item.saving_throws.map(s => s.name || s).join(', ')}</p>`;
				if (item.skill_proficiencies) html += `<p><strong>Skill Proficiencies:</strong> ${item.skill_proficiencies.map(s => s.name || s).join(', ')}</p>`;
				break;

			case 'races':
				if (item.ability_bonuses) {
					const bonuses = item.ability_bonuses.map(b => `${b.ability_score.name} +${b.bonus}`).join(', ');
					html += `<p><strong>Ability Bonuses:</strong> ${bonuses}</p>`;
				}
				if (item.speed) html += `<p><strong>Speed:</strong> ${item.speed} ft.</p>`;
				if (item.ability_bonus_options) html += `<p><strong>Flexible Ability Bonus</strong></p>`;
				if (item.language_desc) html += `<p><strong>Languages:</strong> ${item.language_desc}</p>`;
				break;

			case 'skills':
				if (item.ability_score) html += `<p><strong>Ability:</strong> ${item.ability_score.name}</p>`;
				break;

			case 'conditions':
				// Conditions have descriptions shown below
				break;

			case 'damage-types':
				// Damage types have descriptions shown below
				break;

			case 'languages':
				if (item.type) html += `<p><strong>Type:</strong> ${item.type}</p>`;
				if (item.script) html += `<p><strong>Script:</strong> ${item.script}</p>`;
				break;

			case 'traits':
				if (item.races && Array.isArray(item.races) && item.races.length > 0) {
					html += `<p><strong>Races:</strong> ${item.races.map(r => r.name || r).join(', ')}</p>`;
				}
				if (item.subraces && Array.isArray(item.subraces) && item.subraces.length > 0) {
					html += `<p><strong>Subraces:</strong> ${item.subraces.map(s => s.name || s).join(', ')}</p>`;
				}
				break;

			case 'features':
				if (item.class) html += `<p><strong>Class:</strong> ${item.class.name}</p>`;
				if (item.subclass) html += `<p><strong>Subclass:</strong> ${item.subclass.name}</p>`;
				if (item.level) html += `<p><strong>Level:</strong> ${item.level}</p>`;
				break;

			case 'proficiencies':
				if (item.type) html += `<p><strong>Type:</strong> ${item.type}</p>`;
				if (item.races && Array.isArray(item.races) && item.races.length > 0) {
					html += `<p><strong>Races:</strong> ${item.races.map(r => r.name || r).join(', ')}</p>`;
				}
				if (item.classes && Array.isArray(item.classes) && item.classes.length > 0) {
					html += `<p><strong>Classes:</strong> ${item.classes.map(c => c.name || c).join(', ')}</p>`;
				}
				if (item.subclasses && Array.isArray(item.subclasses) && item.subclasses.length > 0) {
					html += `<p><strong>Subclasses:</strong> ${item.subclasses.map(s => s.name || s).join(', ')}</p>`;
				}
				break;

			case 'subclasses':
				if (item.class) html += `<p><strong>Class:</strong> ${item.class.name}</p>`;
				if (item.subclass_flavor) html += `<p><strong>Flavor:</strong> ${item.subclass_flavor}</p>`;
				break;

			case 'subraces':
				if (item.race) html += `<p><strong>Race:</strong> ${item.race.name}</p>`;
				if (item.ability_bonuses) {
					const subraceBonus = item.ability_bonuses.map(b => `${b.ability_score.name} +${b.bonus}`).join(', ');
					html += `<p><strong>Ability Bonuses:</strong> ${subraceBonus}</p>`;
				}
				break;

			case 'magic-schools':
				// Magic schools have descriptions shown below
				break;

			case 'weapon-properties':
				// Weapon properties have descriptions shown below
				break;

			case 'equipment-categories':
				// Equipment categories have descriptions shown below
				break;

			case 'ability-scores':
				if (item.full_name) html += `<p><strong>Full Name:</strong> ${item.full_name}</p>`;
				break;
		}

			if (item.desc && Array.isArray(item.desc)) {
				html += `<div class="search-result-description">${item.desc.map(d => `<p>${d}</p>`).join('')}</div>`;
			} else if (item.desc && typeof item.desc === 'string') {
				html += `<div class="search-result-description"><p>${item.desc}</p></div>`;
			}

			html += '</div>';
			return html;
		}
	}

	// Initialize managers
	window.inventoryManager = new InventoryManager();
	window.searchPageManager = new SearchPageManager();
	
	// Start the app - wait for DOM to be ready
	if (document.readyState === 'loading') {
		document.addEventListener('DOMContentLoaded', () => {
			console.log('[DEBUG] DOM loaded, starting app');
			initApp();
		});
	} else {
		console.log('[DEBUG] DOM already loaded, starting app');
		initApp();
	}
	
	// Load default inventory if needed
	window.inventoryManager.init().catch(err => console.error('Failed to init inventory:', err));
	</script>
</body>
</html>
